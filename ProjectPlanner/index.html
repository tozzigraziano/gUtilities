<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pianificazione Risorse e Progetti</title>
    <style>
        :root {
            --bg-primary: #f5f5f5;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f9f9f9;
            --bg-hover: #f0f0f0;
            --text-primary: #333;
            --text-secondary: #444;
            --text-tertiary: #555;
            --border-color: #ddd;
            --accent-color: #4CAF50;
            --accent-hover: #45a049;
            --danger-color: #f44336;
            --danger-hover: #da190b;
            --info-color: #2196F3;
            --info-hover: #0b7dda;
            --warning-bg: #fff3cd;
            --warning-border: #ffc107;
            --input-bg: #ffffff;
            --input-disabled: #f0f0f0;
            --table-stripe: #f9f9f9;
            --shadow: rgba(0,0,0,0.1);
        }

        [data-theme="dark"] {
            --bg-primary: #1a1a1a;
            --bg-secondary: #2d2d2d;
            --bg-tertiary: #252525;
            --bg-hover: #3a3a3a;
            --text-primary: #e0e0e0;
            --text-secondary: #d0d0d0;
            --text-tertiary: #b0b0b0;
            --border-color: #404040;
            --accent-color: #66bb6a;
            --accent-hover: #4caf50;
            --danger-color: #ef5350;
            --danger-hover: #e53935;
            --info-color: #42a5f5;
            --info-hover: #2196f3;
            --warning-bg: #4a4a2a;
            --warning-border: #ffa000;
            --input-bg: #3a3a3a;
            --input-disabled: #2a2a2a;
            --table-stripe: #252525;
            --shadow: rgba(0,0,0,0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 10px;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
            font-size: 13px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: var(--bg-secondary);
            padding: 12px;
            border-radius: 6px;
            box-shadow: 0 2px 4px var(--shadow);
        }

        h1 {
            color: var(--text-primary);
            margin-bottom: 15px;
            text-align: center;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            font-size: 1.6em;
        }

        h2 {
            color: var(--text-secondary);
            margin-top: 15px;
            margin-bottom: 8px;
            padding-bottom: 5px;
            border-bottom: 2px solid var(--accent-color);
            font-size: 1.3em;
        }

        .tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 10px;
            border-bottom: 2px solid var(--border-color);
        }

        .tab {
            padding: 6px 12px;
            background: var(--bg-tertiary);
            border: none;
            cursor: pointer;
            border-radius: 4px 4px 0 0;
            font-size: 13px;
            transition: background 0.3s;
            color: var(--text-primary);
        }

        .tab:hover {
            background: var(--bg-hover);
        }

        .tab.active {
            background: var(--accent-color);
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 8px;
        }

        label {
            display: inline-block;
            width: 150px;
            font-weight: 600;
            color: var(--text-tertiary);
            font-size: 12px;
        }

        input[type="text"],
        input[type="date"],
        input[type="number"],
        select,
        textarea {
            padding: 5px;
            border: 1px solid var(--border-color);
            border-radius: 3px;
            font-size: 12px;
            width: 250px;
            background-color: var(--input-bg);
            color: var(--text-primary);
        }

        input[type="checkbox"] {
            margin-left: 8px;
        }

        textarea {
            width: 500px;
            min-height: 60px;
            resize: vertical;
        }

        button {
            padding: 6px 12px;
            background-color: var(--accent-color);
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            margin-right: 8px;
        }

        button:hover {
            background-color: var(--accent-hover);
        }

        button.delete {
            background-color: var(--danger-color);
        }

        button.delete:hover {
            background-color: var(--danger-hover);
        }

        button.secondary {
            background-color: var(--info-color);
        }

        button.secondary:hover {
            background-color: var(--info-hover);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 12px;
        }

        th, td {
            border: 1px solid var(--border-color);
            padding: 5px 8px;
            text-align: left;
        }

        th {
            background-color: var(--accent-color);
            color: white;
            font-weight: 600;
            font-size: 12px;
        }

        tr:nth-child(even) {
            background-color: var(--table-stripe);
        }

        tr:hover {
            background-color: var(--bg-hover);
        }

        .action-buttons {
            white-space: nowrap;
        }

        .action-buttons button {
            padding: 3px 6px;
            font-size: 11px;
            margin-right: 3px;
        }

        .form-section {
            background: var(--bg-tertiary);
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 12px;
        }

        .inline-group {
            display: inline-block;
            margin-right: 20px;
        }

        .inline-group label {
            width: auto;
            margin-right: 10px;
        }

        .inline-group input[type="text"],
        .inline-group input[type="date"],
        .inline-group input[type="number"] {
            width: 150px;
        }

        .status-not-assigned {
            background-color: #ffeb3b !important;
            color: #000 !important;
        }

        [data-theme="dark"] .status-not-assigned {
            background-color: #8b7500 !important;
            color: #fff !important;
        }

        .status-paused {
            background-color: #ff9800 !important;
            color: #000 !important;
        }

        [data-theme="dark"] .status-paused {
            background-color: #b36b00 !important;
            color: #fff !important;
        }

        .status-in-progress {
            background-color: #4caf50 !important;
            color: white;
        }

        .status-completed {
            background-color: #2196f3 !important;
            color: white;
        }

        .status-overdue {
            background-color: #d32f2f !important;
            color: white;
            font-weight: bold;
        }

        .status-cancelled {
            background-color: #f44336 !important;
            color: white;
        }

        .resource-allocation {
            margin-top: 10px;
            padding: 10px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 4px;
        }

        .resource-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 5px;
        }

        .resource-item select {
            width: 200px;
        }

        .resource-item input[type="number"] {
            width: 80px;
        }

        .absence-range {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 5px;
        }

        .project-item {
            cursor: pointer;
            transition: background 0.2s;
        }

        .project-item.selected {
            background-color: #e3f2fd !important;
        }

        .holidays-info {
            background: var(--warning-bg);
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            border-left: 4px solid var(--warning-border);
            color: var(--text-primary);
        }

        /* Gantt Chart Styles */
        .gantt-container {
            overflow-x: auto;
            margin-top: 20px;
        }

        .gantt-header {
            display: flex;
            margin-bottom: 10px;
            gap: 10px;
            align-items: center;
        }

        .gantt-chart {
            position: relative;
            min-height: 400px;
            overflow-x: auto;
            border: 1px solid var(--border-color);
        }

        .gantt-timeline {
            display: flex;
            border-bottom: 2px solid var(--border-color);
            position: sticky;
            top: 0;
            background: var(--bg-secondary);
            z-index: 11;
        }

        .gantt-timeline-label {
            width: 250px;
            min-width: 250px;
            padding: 5px;
            text-align: center;
            border-right: 2px solid var(--border-color);
            font-size: 11px;
            font-weight: 600;
            background: var(--bg-tertiary);
            position: sticky;
            left: 0;
            z-index: 12;
        }

        .gantt-timeline-item {
            flex: 1;
            min-width: 40px;
            padding: 5px;
            text-align: center;
            border-right: 1px solid var(--border-color);
            font-size: 11px;
            font-weight: 600;
        }

        .gantt-row {
            display: flex;
            position: relative;
            min-height: 40px;
            border-bottom: 1px solid var(--border-color);
        }

        .gantt-row.hidden {
            display: none;
        }

        .gantt-row-label {
            width: 250px;
            min-width: 250px;
            padding: 8px;
            background: var(--bg-tertiary);
            border-right: 2px solid var(--border-color);
            position: sticky;
            left: 0;
            z-index: 5;
            display: flex;
            align-items: center;
            font-size: 12px;
        }

        .gantt-expand-icon {
            cursor: pointer;
            margin-right: 5px;
            user-select: none;
            font-weight: bold;
            width: 16px;
            text-align: center;
        }

        .gantt-row-bars {
            flex: 1;
            position: relative;
            display: flex;
        }

        .gantt-bar {
            position: absolute;
            height: 30px;
            top: 5px;
            border-radius: 4px;
            padding: 5px 10px;
            color: white;
            font-size: 12px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            cursor: pointer;
            box-shadow: 0 2px 4px var(--shadow);
        }

        .gantt-bar.project {
            background: var(--accent-color);
            opacity: 0.3;
        }

        .gantt-bar.milestone {
            background: var(--info-color);
            height: 20px;
            top: 10px;
            clip-path: polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%);
            width: 20px !important;
        }

        .gantt-bar.task {
            background: var(--accent-color);
        }

        .gantt-bar.task.status-paused {
            background: #ff9800;
        }

        .gantt-bar.task.status-cancelled {
            background: var(--danger-color);
            opacity: 0.5;
        }

        .gantt-bar.task.not-assigned {
            background: #ffc107;
        }

        .gantt-day {
            flex: 1;
            min-width: 40px;
            border-right: 1px solid var(--border-color);
        }

        .gantt-day.weekend {
            background: var(--table-stripe);
        }

        .gantt-day.holiday {
            background: var(--warning-bg);
        }

        .gantt-day.today {
            background: rgba(33, 150, 243, 0.1);
        }

        /* Resource View Styles */
        .resource-card {
            background: var(--bg-tertiary);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid var(--accent-color);
        }

        .resource-card.overloaded {
            border-left-color: var(--danger-color);
        }

        .resource-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .resource-name {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .resource-load {
            font-size: 14px;
            padding: 5px 10px;
            border-radius: 4px;
            font-weight: 600;
        }

        .resource-load.normal {
            background: var(--accent-color);
            color: white;
        }

        .resource-load.warning {
            background: #ff9800;
            color: white;
        }

        .resource-load.overload {
            background: var(--danger-color);
            color: white;
        }

        .resource-timeline {
            margin-top: 10px;
        }

        .resource-assignment {
            background: var(--bg-secondary);
            padding: 8px;
            margin-bottom: 5px;
            border-radius: 4px;
            border-left: 3px solid var(--accent-color);
        }

        .resource-assignment.conflict {
            border-left-color: var(--danger-color);
            background: rgba(244, 67, 54, 0.1);
        }

        .assignment-header {
            display: flex;
            justify-content: space-between;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .assignment-details {
            font-size: 12px;
            color: var(--text-tertiary);
        }

        .filter-section {
            background: var(--bg-tertiary);
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        .filter-group {
            display: inline-block;
            margin-right: 20px;
        }

        .gantt-legend {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
            padding: 10px;
            background: var(--bg-tertiary);
            border-radius: 5px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 3px;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal.active {
            display: block;
        }

        .modal-content {
            background-color: var(--bg-secondary);
            margin: 5% auto;
            padding: 0;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            width: 90%;
            max-width: 800px;
            box-shadow: 0 4px 20px var(--shadow);
            animation: modalSlideDown 0.3s ease-out;
        }

        @keyframes modalSlideDown {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            padding: 20px;
            background-color: var(--accent-color);
            color: white;
            border-radius: 8px 8px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 20px;
        }

        .modal-close {
            color: white;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            background: none;
            border: none;
            padding: 0;
            width: 30px;
            height: 30px;
            line-height: 30px;
            text-align: center;
            border-radius: 50%;
            transition: background 0.3s;
        }

        .modal-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .modal-body {
            padding: 20px;
            max-height: 70vh;
            overflow-y: auto;
        }

        .modal-footer {
            padding: 15px 20px;
            background-color: var(--bg-tertiary);
            border-radius: 0 0 8px 8px;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .action-bar {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>
            üìä Pianificazione Risorse e Progetti
            <button class="theme-toggle" onclick="toggleTheme()" title="Cambia tema">üåì</button>
        </h1>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('resources')">Risorse</button>
            <button class="tab" onclick="switchTab('holidays')">Festivit√†</button>
            <button class="tab" onclick="switchTab('projects')">Progetti</button>
            <button class="tab" onclick="switchTab('templates')">Template</button>
            <button class="tab" onclick="switchTab('gantt')">Gantt</button>
            <button class="tab" onclick="switchTab('resourceView')">Vista Risorse</button>
            <button class="tab" onclick="switchTab('data')">Import/Export</button>
        </div>

        <!-- TAB RISORSE -->
        <div id="resources" class="tab-content active">
            <h2>Gestione Risorse</h2>
            
            <div class="action-bar">
                <button onclick="openResourceModal()">‚ûï Nuova Risorsa</button>
            </div>

            <h3>Elenco Risorse</h3>
            <table id="resourcesTable">
                <thead>
                    <tr>
                        <th>Nome</th>
                        <th>Cognome</th>
                        <th>Giorni di Assenza</th>
                        <th>Azioni</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <!-- TAB FESTIVIT√Ä -->
        <div id="holidays" class="tab-content">
            <h2>Festivit√†</h2>
            
            <div class="holidays-info">
                <strong>‚ÑπÔ∏è Festivit√† Italiane</strong><br>
                Le festivit√† italiane standard vengono calcolate automaticamente in base ai progetti inseriti (dalla data pi√π vecchia a quella pi√π recente).
                Puoi aggiungere festivit√† locali ricorrenti (es. Santo Patrono).
            </div>

            <div class="action-bar">
                <button onclick="openLocalHolidayModal()">‚ûï Nuova Festivit√† Locale</button>
            </div>

            <h3>Festivit√† Locali Ricorrenti</h3>
            <table id="localHolidaysTable">
                <thead>
                    <tr>
                        <th>Nome</th>
                        <th>Data</th>
                        <th>Azioni</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>

            <h3>Festivit√† Caricate</h3>
            <table id="holidaysTable">
                <thead>
                    <tr>
                        <th>Data</th>
                        <th>Festivit√†</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <!-- TAB PROGETTI -->
        <div id="projects" class="tab-content">
            <h2>Gestione Progetti</h2>
            
            <div class="action-bar">
                <button onclick="openProjectModal()">‚ûï Nuovo Progetto</button>
                <div style="flex: 1;"></div>
                <label style="margin-right: 10px;">Applica template:</label>
                <select id="applyTemplateSelect" style="width: 250px;">
                    <option value="">-- Seleziona Template --</option>
                </select>
                <button onclick="applyTemplateFromSelect()" class="secondary">üìã Applica a Progetto Selezionato</button>
            </div>

            <h3>Elenco Progetti</h3>
            <table id="projectsTable">
                <thead>
                    <tr>
                        <th>Cliente</th>
                        <th>Codice</th>
                        <th>Descrizione</th>
                        <th>Data Inizio</th>
                        <th>Data Fine</th>
                        <th>Completamento</th>
                        <th>Azioni</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>

            <input type="hidden" id="selectedProjectId">

            <!-- Sezione Punti di Controllo e Attivit√† -->
            <div id="projectDetails" style="display: none;">
                <h2>Dettagli Progetto: <span id="currentProjectName"></span></h2>
                
                <!-- Punti di Controllo -->
                <div class="action-bar">
                    <button onclick="openMilestoneModal()">‚ûï Nuovo Punto di Controllo</button>
                </div>

                <h3>Punti di Controllo</h3>
                <table id="milestonesTable">
                    <thead>
                        <tr>
                            <th>Nome</th>
                            <th>Data</th>
                            <th>Azioni</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>

                <!-- Attivit√† -->
                <div class="action-bar">
                    <button onclick="openTaskModal()">‚ûï Nuova Attivit√†</button>
                </div>

                <h3>Attivit√†</h3>
                <table id="tasksTable">
                    <thead>
                        <tr>
                            <th>Nome</th>
                            <th>Risorse</th>
                            <th>Data Inizio</th>
                            <th>Data Fine</th>
                            <th>Durata</th>
                            <th>Completamento</th>
                            <th>Stato</th>
                            <th>Azioni</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>

                <button onclick="closeProjectDetails()" class="secondary">‚Üê Torna ai Progetti</button>
            </div>
        </div>

        <!-- TAB TEMPLATE -->
        <div id="templates" class="tab-content">
            <h2>Template Progetti</h2>
            
            <div class="action-bar">
                <button onclick="openTemplateModal()">‚ûï Nuovo Template</button>
            </div>

            <h3>Template Disponibili</h3>
            <table id="templatesTable">
                <thead>
                    <tr>
                        <th>Nome Template</th>
                        <th>Milestone</th>
                        <th>Attivit√†</th>
                        <th>Azioni</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>

            <!-- Sezione Dettagli Template -->
            <div id="templateDetails" style="display: none;">
                <h2>Dettagli Template: <span id="currentTemplateName"></span></h2>
                
                <!-- Punti di Controllo Template -->
                <div class="action-bar">
                    <button onclick="openTemplateMilestoneModal()">‚ûï Nuovo Punto di Controllo</button>
                </div>

                <h3>Punti di Controllo</h3>
                <table id="templateMilestonesTable">
                    <thead>
                        <tr>
                            <th>Nome</th>
                            <th>Giorni dall'inizio</th>
                            <th>Azioni</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>

                <!-- Attivit√† Template -->
                <div class="action-bar">
                    <button onclick="openTemplateTaskModal()">‚ûï Nuova Attivit√†</button>
                </div>

                <h3>Attivit√†</h3>
                <table id="templateTasksTable">
                    <thead>
                        <tr>
                            <th>Nome</th>
                            <th>Giorni dall'inizio</th>
                            <th>Durata</th>
                            <th>Sab</th>
                            <th>Dom</th>
                            <th>Azioni</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>

                <button onclick="closeTemplateDetails()" class="secondary">‚Üê Torna ai Template</button>
            </div>
        </div>

        <!-- TAB IMPORT/EXPORT -->
        <div id="data" class="tab-content">
            <h2>Import/Export Dati</h2>
            
            <div class="form-section">
                <h3>Esporta Dati</h3>
                <p>Esporta tutti i dati (risorse, progetti, festivit√† locali, template) in un file JSON.</p>
                <button onclick="exportData()">üíæ Esporta Tutti i Dati</button>
            </div>

            <div class="form-section">
                <h3>Importa Dati</h3>
                <p>Importa dati da un file JSON precedentemente esportato.</p>
                <input type="file" id="importFile" accept=".json" style="margin-bottom: 10px;">
                <br>
                <button onclick="importData()">üìÇ Importa Dati</button>
                <button onclick="importDataMerge()" class="secondary">üìÇ Importa e Unisci</button>
            </div>

            <div class="holidays-info">
                <strong>‚ö†Ô∏è Attenzione</strong><br>
                <strong>Importa Dati</strong>: sostituisce completamente tutti i dati correnti.<br>
                <strong>Importa e Unisci</strong>: aggiunge i dati importati a quelli esistenti.
            </div>
        </div>

        <!-- TAB GANTT -->
        <div id="gantt" class="tab-content">
            <h2>Diagramma di Gantt</h2>

            <div class="filter-section">
                <div class="filter-group">
                    <label>Progetto:</label>
                    <select id="ganttProjectFilter" onchange="renderGantt()">
                        <option value="">Tutti i Progetti</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Periodo:</label>
                    <select id="ganttPeriodFilter" onchange="renderGantt()">
                        <option value="week">Settimana</option>
                        <option value="month" selected>Mese</option>
                        <option value="quarter">Trimestre</option>
                        <option value="year">Anno</option>
                        <option value="all">Tutti</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Vista:</label>
                    <select id="ganttViewFilter" onchange="renderGantt()">
                        <option value="projects">Per Progetto</option>
                        <option value="resources">Per Risorsa</option>
                    </select>
                </div>
                <button onclick="renderGantt()" class="secondary">üîÑ Aggiorna</button>
            </div>

            <div class="gantt-legend">
                <div class="legend-item">
                    <div class="legend-color" style="background: var(--accent-color);"></div>
                    <span>Attivit√† in corso</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #ff9800;"></div>
                    <span>In pausa</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #ffc107;"></div>
                    <span>Non assegnata</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: var(--info-color); clip-path: polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%);"></div>
                    <span>Milestone</span>
                </div>
            </div>

            <div class="gantt-container">
                <div id="ganttChart" class="gantt-chart"></div>
            </div>
        </div>

        <!-- TAB VISTA RISORSE -->
        <div id="resourceView" class="tab-content">
            <h2>Vista Risorse e Carico di Lavoro</h2>

            <div class="filter-section">
                <div class="filter-group">
                    <label>Risorsa:</label>
                    <select id="resourceViewFilter" onchange="renderResourceView()">
                        <option value="">Tutte le Risorse</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Periodo:</label>
                    <input type="date" id="resourceViewStartDate" onchange="renderResourceView()">
                    <span> - </span>
                    <input type="date" id="resourceViewEndDate" onchange="renderResourceView()">
                </div>
                <button onclick="renderResourceView()" class="secondary">üîÑ Aggiorna</button>
            </div>

            <div class="holidays-info">
                <strong>‚ö†Ô∏è Indicatori di Carico</strong><br>
                <strong style="color: var(--accent-color);">Verde</strong>: Carico normale (‚â§ 100%)<br>
                <strong style="color: #ff9800;">Arancione</strong>: Sovraccarico moderato (100-150%)<br>
                <strong style="color: var(--danger-color);">Rosso</strong>: Sovraccarico critico (> 150%)
            </div>

            <div id="resourceViewContainer"></div>
        </div>
    </div>

    <!-- MODAL DIALOGS -->
    
    <!-- Modal Risorsa -->
    <div id="resourceModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="resourceModalTitle">Nuova Risorsa</h3>
                <button class="modal-close" onclick="closeResourceModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Nome:</label>
                    <input type="text" id="resourceFirstName" placeholder="Nome">
                </div>
                <div class="form-group">
                    <label>Cognome:</label>
                    <input type="text" id="resourceLastName" placeholder="Cognome">
                </div>
                <div class="form-group">
                    <label>Giorni di Assenza:</label>
                    <div id="absenceDays">
                        <div class="absence-range">
                            <input type="date" class="absence-start">
                            <span>-</span>
                            <input type="date" class="absence-end">
                            <button type="button" onclick="addAbsenceRange()">+ Aggiungi Periodo</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button onclick="closeResourceModal()" class="secondary">Annulla</button>
                <button onclick="saveResource()">üíæ Salva</button>
            </div>
        </div>
    </div>

    <!-- Modal Festivit√† Locale -->
    <div id="localHolidayModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="localHolidayModalTitle">Nuova Festivit√† Locale</h3>
                <button class="modal-close" onclick="closeLocalHolidayModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Nome Festivit√†:</label>
                    <input type="text" id="localHolidayName" placeholder="Es: San Giovanni (Patrono)">
                </div>
                <div class="form-group">
                    <label>Giorno:</label>
                    <input type="number" id="localHolidayDay" min="1" max="31" placeholder="Giorno">
                </div>
                <div class="form-group">
                    <label>Mese:</label>
                    <select id="localHolidayMonth">
                        <option value="1">Gennaio</option>
                        <option value="2">Febbraio</option>
                        <option value="3">Marzo</option>
                        <option value="4">Aprile</option>
                        <option value="5">Maggio</option>
                        <option value="6">Giugno</option>
                        <option value="7">Luglio</option>
                        <option value="8">Agosto</option>
                        <option value="9">Settembre</option>
                        <option value="10">Ottobre</option>
                        <option value="11">Novembre</option>
                        <option value="12">Dicembre</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button onclick="closeLocalHolidayModal()" class="secondary">Annulla</button>
                <button onclick="saveLocalHoliday()">üíæ Salva</button>
            </div>
        </div>
    </div>

    <!-- Modal Progetto -->
    <div id="projectModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="projectModalTitle">Nuovo Progetto</h3>
                <button class="modal-close" onclick="closeProjectModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Cliente:</label>
                    <input type="text" id="projectClient" placeholder="Nome Cliente">
                </div>
                <div class="form-group">
                    <label>Codice Lavoro:</label>
                    <input type="text" id="projectCode" placeholder="Codice">
                </div>
                <div class="form-group">
                    <label>Descrizione:</label>
                    <textarea id="projectDescription" placeholder="Descrizione del progetto"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button onclick="closeProjectModal()" class="secondary">Annulla</button>
                <button onclick="saveProject()">üíæ Salva</button>
            </div>
        </div>
    </div>

    <!-- Modal Milestone -->
    <div id="milestoneModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="milestoneModalTitle">Nuovo Punto di Controllo</h3>
                <button class="modal-close" onclick="closeMilestoneModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Nome Milestone:</label>
                    <input type="text" id="milestoneName" placeholder="Nome del punto di controllo">
                </div>
                <div class="form-group">
                    <label>Data:</label>
                    <input type="date" id="milestoneDate">
                </div>
            </div>
            <div class="modal-footer">
                <button onclick="closeMilestoneModal()" class="secondary">Annulla</button>
                <button onclick="saveMilestone()">üíæ Salva</button>
            </div>
        </div>
    </div>

    <!-- Modal Task -->
    <div id="taskModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="taskModalTitle">Nuova Attivit√†</h3>
                <button class="modal-close" onclick="closeTaskModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Nome Attivit√†:</label>
                    <input type="text" id="taskName" placeholder="Nome dell'attivit√†">
                </div>
                <div class="form-group">
                    <label>Metodo Calcolo:</label>
                    <div class="inline-group">
                        <input type="radio" id="calcFromStart" name="calcMethod" value="start" checked>
                        <label for="calcFromStart">Inizio + Durata</label>
                    </div>
                    <div class="inline-group">
                        <input type="radio" id="calcFromEnd" name="calcMethod" value="end">
                        <label for="calcFromEnd">Fine + Durata</label>
                    </div>
                </div>
                <div class="form-group">
                    <label>Data Inizio:</label>
                    <input type="date" id="taskStartDate">
                    <small>(lascia vuoto se legata ad altra attivit√†)</small>
                </div>
                <div class="form-group">
                    <label>Data Fine:</label>
                    <input type="date" id="taskEndDate">
                </div>
                <div class="form-group">
                    <label>Durata (giorni):</label>
                    <input type="number" id="taskDuration" min="1" value="1">
                </div>
                <div class="form-group">
                    <label>Completamento (%):</label>
                    <input type="number" id="taskCompletion" min="0" max="100" value="0">
                </div>
                <div class="form-group">
                    <label>Stato:</label>
                    <select id="taskStatus">
                        <option value="in-corso">In Corso</option>
                        <option value="pausa">In Pausa</option>
                        <option value="completata">Completata</option>
                        <option value="annullata">Annullata</option>
                    </select>
                </div>
                <div class="form-group">
                    <label></label>
                    <div class="inline-group">
                        <input type="checkbox" id="taskSaturdayWork">
                        <label for="taskSaturdayWork">Sabato Lavorativo</label>
                    </div>
                    <div class="inline-group">
                        <input type="checkbox" id="taskSundayWork">
                        <label for="taskSundayWork">Domenica Lavorativa</label>
                    </div>
                </div>
                <div class="form-group">
                    <label>Risorse Assegnate:</label>
                    <div class="resource-allocation" id="taskResources">
                        <div class="resource-item">
                            <select class="task-resource-select">
                                <option value="">-- Seleziona Risorsa --</option>
                            </select>
                            <label>Coinvolgimento:</label>
                            <input type="number" class="task-resource-percentage" min="1" max="100" value="100" placeholder="%">
                            <span>%</span>
                            <button type="button" onclick="addTaskResource()">+ Aggiungi Risorsa</button>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label>Data Fine Calcolata:</label>
                    <input type="date" id="taskEndDate" readonly style="background: var(--input-disabled);">
                </div>
            </div>
            <div class="modal-footer">
                <button onclick="closeTaskModal()" class="secondary">Annulla</button>
                <button onclick="saveTask()">üíæ Salva</button>
            </div>
        </div>
    </div>

    <!-- Modal Template -->
    <div id="templateModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="templateModalTitle">Nuovo Template</h3>
                <button class="modal-close" onclick="closeTemplateModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Nome Template:</label>
                    <input type="text" id="templateName" placeholder="Nome del template">
                </div>
            </div>
            <div class="modal-footer">
                <button onclick="closeTemplateModal()" class="secondary">Annulla</button>
                <button onclick="saveTemplateStandalone()">üíæ Salva</button>
            </div>
        </div>
    </div>

    <!-- Modal Template Milestone -->
    <div id="templateMilestoneModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="templateMilestoneModalTitle">Nuovo Punto di Controllo</h3>
                <button class="modal-close" onclick="closeTemplateMilestoneModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Nome Milestone:</label>
                    <input type="text" id="templateMilestoneName" placeholder="Nome del punto di controllo">
                </div>
                <div class="form-group">
                    <label>Giorni dall'inizio:</label>
                    <input type="number" id="templateMilestoneDay" min="0" value="0" placeholder="Giorni dall'inizio progetto">
                </div>
            </div>
            <div class="modal-footer">
                <button onclick="closeTemplateMilestoneModal()" class="secondary">Annulla</button>
                <button onclick="saveTemplateMilestone()">üíæ Salva</button>
            </div>
        </div>
    </div>

    <!-- Modal Template Task -->
    <div id="templateTaskModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="templateTaskModalTitle">Nuova Attivit√†</h3>
                <button class="modal-close" onclick="closeTemplateTaskModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Nome Attivit√†:</label>
                    <input type="text" id="templateTaskName" placeholder="Nome dell'attivit√†">
                </div>
                <div class="form-group">
                    <label>Giorni dall'inizio:</label>
                    <input type="number" id="templateTaskStartDay" min="0" value="0" placeholder="Giorni dall'inizio progetto">
                </div>
                <div class="form-group">
                    <label>Durata (giorni):</label>
                    <input type="number" id="templateTaskDuration" min="1" value="1">
                </div>
                <div class="form-group">
                    <label></label>
                    <div class="inline-group">
                        <input type="checkbox" id="templateTaskSaturdayWork">
                        <label for="templateTaskSaturdayWork">Sabato Lavorativo</label>
                    </div>
                    <div class="inline-group">
                        <input type="checkbox" id="templateTaskSundayWork">
                        <label for="templateTaskSundayWork">Domenica Lavorativa</label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button onclick="closeTemplateTaskModal()" class="secondary">Annulla</button>
                <button onclick="saveTemplateTask()">üíæ Salva</button>
            </div>
        </div>
    </div>

    <script>
        // === INDEXEDDB SETUP ===
        const DB_NAME = 'ProjectPlannerDB';
        const DB_VERSION = 1;
        let db = null;

        // Inizializza IndexedDB
        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);

                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    db = request.result;
                    resolve(db);
                };

                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    
                    // Crea object stores se non esistono
                    if (!db.objectStoreNames.contains('resources')) {
                        db.createObjectStore('resources', { keyPath: 'id' });
                    }
                    if (!db.objectStoreNames.contains('localHolidays')) {
                        db.createObjectStore('localHolidays', { keyPath: 'id' });
                    }
                    if (!db.objectStoreNames.contains('projects')) {
                        db.createObjectStore('projects', { keyPath: 'id' });
                    }
                    if (!db.objectStoreNames.contains('templates')) {
                        db.createObjectStore('templates', { keyPath: 'id' });
                    }
                    if (!db.objectStoreNames.contains('settings')) {
                        db.createObjectStore('settings', { keyPath: 'key' });
                    }
                };
            });
        }

        // Salva dati in IndexedDB
        async function saveToIndexedDB(storeName, data) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                
                // Clear existing data
                store.clear();
                
                // Add all items
                data.forEach(item => store.add(item));
                
                transaction.oncomplete = () => resolve();
                transaction.onerror = () => reject(transaction.error);
            });
        }

        // Carica dati da IndexedDB
        async function loadFromIndexedDB(storeName) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([storeName], 'readonly');
                const store = transaction.objectStore(storeName);
                const request = store.getAll();
                
                request.onsuccess = () => resolve(request.result || []);
                request.onerror = () => reject(request.error);
            });
        }

        // Salva singola impostazione
        async function saveSetting(key, value) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['settings'], 'readwrite');
                const store = transaction.objectStore('settings');
                store.put({ key, value });
                
                transaction.oncomplete = () => resolve();
                transaction.onerror = () => reject(transaction.error);
            });
        }

        // Carica singola impostazione
        async function loadSetting(key) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['settings'], 'readonly');
                const store = transaction.objectStore('settings');
                const request = store.get(key);
                
                request.onsuccess = () => resolve(request.result?.value);
                request.onerror = () => reject(request.error);
            });
        }

        // Migrazione da LocalStorage a IndexedDB (esegui una volta)
        async function migrateFromLocalStorage() {
            const keys = ['resources', 'localHolidays', 'projects', 'templates'];
            
            for (const key of keys) {
                const data = localStorage.getItem(`projectPlanner_${key}`);
                if (data) {
                    const parsed = JSON.parse(data);
                    await saveToIndexedDB(key, parsed);
                    // Opzionale: rimuovi da localStorage dopo migrazione
                    // localStorage.removeItem(`projectPlanner_${key}`);
                }
            }
        }

        // === THEME MANAGEMENT ===
        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', newTheme);
            saveSetting('theme', newTheme);
        }

        async function loadTheme() {
            const savedTheme = await loadSetting('theme');
            if (savedTheme) {
                document.documentElement.setAttribute('data-theme', savedTheme);
            } else {
                // Rileva preferenza sistema
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                if (prefersDark) {
                    document.documentElement.setAttribute('data-theme', 'dark');
                }
            }
        }

        // Strutture dati
        let resources = [];
        let holidays = [];
        let localHolidays = []; // Festivit√† locali ricorrenti
        let projects = [];
        let templates = [];
        let currentProjectId = null;
        let currentTemplateId = null;
        let editingResourceId = null;
        let editingMilestoneId = null;
        let editingTaskId = null;
        let editingLocalHolidayId = null;
        let editingTemplateMilestoneId = null;
        let editingTemplateTaskId = null;

        // Inizializzazione
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // Inizializza IndexedDB
                await initDB();
                
                // Carica tema
                await loadTheme();
                
                // Migra da LocalStorage se necessario (solo prima volta)
                const migrated = await loadSetting('migrated');
                if (!migrated) {
                    await migrateFromLocalStorage();
                    await saveSetting('migrated', true);
                }
                
                // Carica dati
                await loadFromIndexedDBAll();
                
                // Calcola e renderizza
                calculateHolidays();
                renderResources();
                renderLocalHolidays();
                renderHolidays();
                renderProjects();
                renderTemplates();
                updateResourceSelects();
                updateProjectSelects();
                updateTemplateSelects();
                updateApplyTemplateSelect();
                updateGanttFilters();
                updateResourceViewFilters();
            } catch (error) {
                console.error('Errore inizializzazione:', error);
                alert('Errore nel caricamento dei dati. Verifica la console.');
            }
        });

        // Funzioni per il cambio tab
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
        }

        // === MODAL MANAGEMENT ===
        function openResourceModal(id = null) {
            editingResourceId = id;
            const modal = document.getElementById('resourceModal');
            const title = document.getElementById('resourceModalTitle');
            
            if (id) {
                title.textContent = 'Modifica Risorsa';
                const resource = resources.find(r => r.id === id);
                if (resource) {
                    document.getElementById('resourceFirstName').value = resource.firstName;
                    document.getElementById('resourceLastName').value = resource.lastName;
                    
                    const container = document.getElementById('absenceDays');
                    container.innerHTML = '';
                    
                    if (resource.absences && resource.absences.length > 0) {
                        resource.absences.forEach((absence, index) => {
                            const newRange = document.createElement('div');
                            newRange.className = 'absence-range';
                            newRange.innerHTML = `
                                <input type="date" class="absence-start" value="${absence.start}">
                                <span>-</span>
                                <input type="date" class="absence-end" value="${absence.end}">
                                ${index === 0 ? 
                                    '<button type="button" onclick="addAbsenceRange()">+ Aggiungi Periodo</button>' :
                                    '<button type="button" onclick="removeAbsenceRange(this)" class="delete">Rimuovi</button>'}
                            `;
                            container.appendChild(newRange);
                        });
                    } else {
                        addAbsenceRange();
                    }
                }
            } else {
                title.textContent = 'Nuova Risorsa';
                clearResourceForm();
            }
            
            modal.classList.add('active');
        }

        function closeResourceModal() {
            document.getElementById('resourceModal').classList.remove('active');
            clearResourceForm();
        }

        function openLocalHolidayModal(id = null) {
            editingLocalHolidayId = id;
            const modal = document.getElementById('localHolidayModal');
            const title = document.getElementById('localHolidayModalTitle');
            
            if (id) {
                title.textContent = 'Modifica Festivit√† Locale';
                const holiday = localHolidays.find(h => h.id === id);
                if (holiday) {
                    document.getElementById('localHolidayName').value = holiday.name;
                    document.getElementById('localHolidayDay').value = holiday.day;
                    document.getElementById('localHolidayMonth').value = holiday.month;
                }
            } else {
                title.textContent = 'Nuova Festivit√† Locale';
                clearLocalHolidayForm();
            }
            
            modal.classList.add('active');
        }

        function closeLocalHolidayModal() {
            document.getElementById('localHolidayModal').classList.remove('active');
            clearLocalHolidayForm();
        }

        function openProjectModal(id = null) {
            currentProjectId = id;
            const modal = document.getElementById('projectModal');
            const title = document.getElementById('projectModalTitle');
            
            if (id) {
                title.textContent = 'Modifica Progetto';
                const project = projects.find(p => p.id === id);
                if (project) {
                    document.getElementById('projectClient').value = project.client;
                    document.getElementById('projectCode').value = project.code;
                    document.getElementById('projectDescription').value = project.description;
                }
            } else {
                title.textContent = 'Nuovo Progetto';
                clearProjectForm();
            }
            
            modal.classList.add('active');
        }

        function closeProjectModal() {
            document.getElementById('projectModal').classList.remove('active');
            clearProjectForm();
        }

        function openMilestoneModal(id = null) {
            editingMilestoneId = id;
            const modal = document.getElementById('milestoneModal');
            const title = document.getElementById('milestoneModalTitle');
            
            if (id) {
                title.textContent = 'Modifica Punto di Controllo';
                const project = projects.find(p => p.id === currentProjectId);
                if (project) {
                    const milestone = project.milestones.find(m => m.id === id);
                    if (milestone) {
                        document.getElementById('milestoneName').value = milestone.name;
                        document.getElementById('milestoneDate').value = milestone.date;
                    }
                }
            } else {
                title.textContent = 'Nuovo Punto di Controllo';
                clearMilestoneForm();
            }
            
            modal.classList.add('active');
        }

        function closeMilestoneModal() {
            document.getElementById('milestoneModal').classList.remove('active');
            clearMilestoneForm();
        }

        function openTaskModal(id = null) {
            editingTaskId = id;
            const modal = document.getElementById('taskModal');
            const title = document.getElementById('taskModalTitle');
            
            if (id) {
                title.textContent = 'Modifica Attivit√†';
                const project = projects.find(p => p.id === currentProjectId);
                if (project) {
                    const task = project.tasks.find(t => t.id === id);
                    if (task) {
                        document.getElementById('taskName').value = task.name;
                        document.getElementById('taskStartDate').value = task.startDate || '';
                        document.getElementById('taskDuration').value = task.duration;
                        document.getElementById('taskCompletion').value = task.completion;
                        document.getElementById('taskStatus').value = task.status;
                        document.getElementById('taskSaturdayWork').checked = task.saturdayWork;
                        document.getElementById('taskSundayWork').checked = task.sundayWork;
                        document.getElementById('taskEndDate').value = task.endDate;

                        const container = document.getElementById('taskResources');
                        container.innerHTML = '';

                        if (task.resources && task.resources.length > 0) {
                            task.resources.forEach((res, index) => {
                                const newResource = document.createElement('div');
                                newResource.className = 'resource-item';
                                
                                let options = '<option value="">-- Seleziona Risorsa --</option>';
                                resources.forEach(r => {
                                    const selected = r.id === res.resourceId ? 'selected' : '';
                                    options += `<option value="${r.id}" ${selected}>${r.firstName} ${r.lastName}</option>`;
                                });

                                newResource.innerHTML = `
                                    <select class="task-resource-select">${options}</select>
                                    <label>Coinvolgimento:</label>
                                    <input type="number" class="task-resource-percentage" min="1" max="100" value="${res.percentage}" placeholder="%">
                                    <span>%</span>
                                    ${index === 0 ? 
                                        '<button type="button" onclick="addTaskResource()">+ Aggiungi Risorsa</button>' :
                                        '<button type="button" onclick="removeTaskResource(this)" class="delete">Rimuovi</button>'}
                                `;
                                container.appendChild(newResource);
                            });
                        } else {
                            addTaskResourceRow();
                        }
                    }
                }
            } else {
                title.textContent = 'Nuova Attivit√†';
                clearTaskForm();
            }
            
            updateResourceSelects();
            modal.classList.add('active');
        }

        function closeTaskModal() {
            document.getElementById('taskModal').classList.remove('active');
            clearTaskForm();
        }

        function openTemplateModal(id = null) {
            currentTemplateId = id;
            const modal = document.getElementById('templateModal');
            const title = document.getElementById('templateModalTitle');
            
            if (id) {
                title.textContent = 'Modifica Template';
                const template = templates.find(t => t.id === id);
                if (template) {
                    document.getElementById('templateName').value = template.name;
                }
            } else {
                title.textContent = 'Nuovo Template';
                clearTemplateForm();
            }
            
            modal.classList.add('active');
        }

        function closeTemplateModal() {
            document.getElementById('templateModal').classList.remove('active');
            clearTemplateForm();
        }

        function openTemplateMilestoneModal(id = null) {
            editingTemplateMilestoneId = id;
            const modal = document.getElementById('templateMilestoneModal');
            const title = document.getElementById('templateMilestoneModalTitle');
            
            if (id) {
                title.textContent = 'Modifica Punto di Controllo';
                const template = templates.find(t => t.id === currentTemplateId);
                if (template) {
                    const milestone = template.milestones.find(m => m.id === id);
                    if (milestone) {
                        document.getElementById('templateMilestoneName').value = milestone.name;
                        document.getElementById('templateMilestoneDay').value = milestone.dayOffset;
                    }
                }
            } else {
                title.textContent = 'Nuovo Punto di Controllo';
                clearTemplateMilestoneForm();
            }
            
            modal.classList.add('active');
        }

        function closeTemplateMilestoneModal() {
            document.getElementById('templateMilestoneModal').classList.remove('active');
            clearTemplateMilestoneForm();
        }

        function openTemplateTaskModal(id = null) {
            editingTemplateTaskId = id;
            const modal = document.getElementById('templateTaskModal');
            const title = document.getElementById('templateTaskModalTitle');
            
            if (id) {
                title.textContent = 'Modifica Attivit√†';
                const template = templates.find(t => t.id === currentTemplateId);
                if (template) {
                    const task = template.tasks.find(t => t.id === id);
                    if (task) {
                        document.getElementById('templateTaskName').value = task.name;
                        document.getElementById('templateTaskStartDay').value = task.startDayOffset;
                        document.getElementById('templateTaskDuration').value = task.duration;
                        document.getElementById('templateTaskSaturdayWork').checked = task.saturdayWork;
                        document.getElementById('templateTaskSundayWork').checked = task.sundayWork;
                    }
                }
            } else {
                title.textContent = 'Nuova Attivit√†';
                clearTemplateTaskForm();
            }
            
            modal.classList.add('active');
        }

        function closeTemplateTaskModal() {
            document.getElementById('templateTaskModal').classList.remove('active');
            clearTemplateTaskForm();
        }

        // === GESTIONE RISORSE ===
        function addAbsenceRange() {
            const container = document.getElementById('absenceDays');
            const newRange = document.createElement('div');
            newRange.className = 'absence-range';
            newRange.innerHTML = `
                <input type="date" class="absence-start">
                <span>-</span>
                <input type="date" class="absence-end">
                <button type="button" onclick="removeAbsenceRange(this)" class="delete">Rimuovi</button>
            `;
            container.appendChild(newRange);
        }

        function removeAbsenceRange(button) {
            button.parentElement.remove();
        }

        function saveResource() {
            const firstName = document.getElementById('resourceFirstName').value.trim();
            const lastName = document.getElementById('resourceLastName').value.trim();
            
            if (!firstName || !lastName) {
                alert('Nome e Cognome sono obbligatori');
                return;
            }

            const absences = [];
            document.querySelectorAll('.absence-range').forEach(range => {
                const start = range.querySelector('.absence-start').value;
                const end = range.querySelector('.absence-end').value || start;
                if (start) {
                    absences.push({ start, end });
                }
            });

            const resource = {
                id: editingResourceId || Date.now(),
                firstName,
                lastName,
                absences
            };

            if (editingResourceId) {
                const index = resources.findIndex(r => r.id === editingResourceId);
                resources[index] = resource;
            } else {
                resources.push(resource);
            }

            saveToIndexedDBAll();
            renderResources();
            updateResourceSelects();
            closeResourceModal();
        }

        function editResource(id) {
            const resource = resources.find(r => r.id === id);
            if (!resource) return;

            editingResourceId = id;
            document.getElementById('resourceFirstName').value = resource.firstName;
            document.getElementById('resourceLastName').value = resource.lastName;

            // Clear existing absence ranges
            const container = document.getElementById('absenceDays');
            container.innerHTML = '';

            // Add absence ranges
            if (resource.absences && resource.absences.length > 0) {
                resource.absences.forEach((absence, index) => {
                    const newRange = document.createElement('div');
                    newRange.className = 'absence-range';
                    newRange.innerHTML = `
                        <input type="date" class="absence-start" value="${absence.start}">
                        <span>-</span>
                        <input type="date" class="absence-end" value="${absence.end}">
                        ${index === 0 ? 
                            '<button type="button" onclick="addAbsenceRange()">+ Aggiungi Periodo</button>' :
                            '<button type="button" onclick="removeAbsenceRange(this)" class="delete">Rimuovi</button>'}
                    `;
                    container.appendChild(newRange);
                });
            } else {
                addAbsenceRange();
            }

            document.getElementById('resourceFirstName').scrollIntoView({ behavior: 'smooth' });
        }

        function deleteResource(id) {
            if (!confirm('Sei sicuro di voler eliminare questa risorsa?')) return;
            resources = resources.filter(r => r.id !== id);
            saveToIndexedDBAll();
            renderResources();
            updateResourceSelects();
        }

        function clearResourceForm() {
            editingResourceId = null;
            document.getElementById('resourceFirstName').value = '';
            document.getElementById('resourceLastName').value = '';
            const container = document.getElementById('absenceDays');
            container.innerHTML = `
                <div class="absence-range">
                    <input type="date" class="absence-start">
                    <span>-</span>
                    <input type="date" class="absence-end">
                    <button type="button" onclick="addAbsenceRange()">+ Aggiungi Periodo</button>
                </div>
            `;
        }

        function renderResources() {
            const tbody = document.querySelector('#resourcesTable tbody');
            tbody.innerHTML = '';

            resources.forEach(resource => {
                const tr = document.createElement('tr');
                const absencesStr = resource.absences.map(a => {
                    if (a.start === a.end) return a.start;
                    return `${a.start} - ${a.end}`;
                }).join(', ') || 'Nessuna';

                tr.innerHTML = `
                    <td>${resource.firstName}</td>
                    <td>${resource.lastName}</td>
                    <td>${absencesStr}</td>
                    <td class="action-buttons">
                        <button onclick="openResourceModal(${resource.id})" class="secondary">‚úèÔ∏è Modifica</button>
                        <button onclick="deleteResource(${resource.id})" class="delete">üóëÔ∏è Elimina</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // === GESTIONE FESTIVIT√Ä LOCALI ===
        function saveLocalHoliday() {
            const name = document.getElementById('localHolidayName').value.trim();
            const day = parseInt(document.getElementById('localHolidayDay').value);
            const month = parseInt(document.getElementById('localHolidayMonth').value);
            
            if (!name || !day || !month) {
                alert('Tutti i campi sono obbligatori');
                return;
            }

            if (day < 1 || day > 31) {
                alert('Giorno non valido');
                return;
            }

            const localHoliday = {
                id: editingLocalHolidayId || Date.now(),
                name,
                day,
                month
            };

            if (editingLocalHolidayId) {
                const index = localHolidays.findIndex(h => h.id === editingLocalHolidayId);
                localHolidays[index] = localHoliday;
            } else {
                localHolidays.push(localHoliday);
            }

            saveToIndexedDBAll();
            calculateHolidays();
            renderLocalHolidays();
            renderHolidays();
            closeLocalHolidayModal();
        }

        function editLocalHoliday(id) {
            const holiday = localHolidays.find(h => h.id === id);
            if (!holiday) return;

            editingLocalHolidayId = id;
            document.getElementById('localHolidayName').value = holiday.name;
            document.getElementById('localHolidayDay').value = holiday.day;
            document.getElementById('localHolidayMonth').value = holiday.month;

            document.getElementById('localHolidayName').scrollIntoView({ behavior: 'smooth' });
        }

        function deleteLocalHoliday(id) {
            if (!confirm('Sei sicuro di voler eliminare questa festivit√† locale?')) return;
            localHolidays = localHolidays.filter(h => h.id !== id);
            saveToIndexedDBAll();
            calculateHolidays();
            renderLocalHolidays();
            renderHolidays();
        }

        function clearLocalHolidayForm() {
            editingLocalHolidayId = null;
            document.getElementById('localHolidayName').value = '';
            document.getElementById('localHolidayDay').value = '';
            document.getElementById('localHolidayMonth').value = '1';
        }

        function renderLocalHolidays() {
            const tbody = document.querySelector('#localHolidaysTable tbody');
            tbody.innerHTML = '';

            localHolidays.forEach(holiday => {
                const tr = document.createElement('tr');
                const monthNames = ['Gen', 'Feb', 'Mar', 'Apr', 'Mag', 'Giu', 'Lug', 'Ago', 'Set', 'Ott', 'Nov', 'Dic'];
                tr.innerHTML = `
                    <td>${holiday.name}</td>
                    <td>${holiday.day} ${monthNames[holiday.month - 1]}</td>
                    <td class="action-buttons">
                        <button onclick="openLocalHolidayModal(${holiday.id})" class="secondary">‚úèÔ∏è Modifica</button>
                        <button onclick="deleteLocalHoliday(${holiday.id})" class="delete">üóëÔ∏è Elimina</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // === GESTIONE FESTIVIT√Ä ===
        function getItalianHolidays(year) {
            const holidays = [];
            
            // Festivit√† fisse
            holidays.push({ date: `${year}-01-01`, name: 'Capodanno' });
            holidays.push({ date: `${year}-01-06`, name: 'Epifania' });
            holidays.push({ date: `${year}-04-25`, name: 'Festa della Liberazione' });
            holidays.push({ date: `${year}-05-01`, name: 'Festa dei Lavoratori' });
            holidays.push({ date: `${year}-06-02`, name: 'Festa della Repubblica' });
            holidays.push({ date: `${year}-08-15`, name: 'Ferragosto' });
            holidays.push({ date: `${year}-11-01`, name: 'Tutti i Santi' });
            holidays.push({ date: `${year}-12-08`, name: 'Immacolata Concezione' });
            holidays.push({ date: `${year}-12-25`, name: 'Natale' });
            holidays.push({ date: `${year}-12-26`, name: 'Santo Stefano' });

            // Calcolo Pasqua (algoritmo di Gauss)
            const a = year % 19;
            const b = Math.floor(year / 100);
            const c = year % 100;
            const d = Math.floor(b / 4);
            const e = b % 4;
            const f = Math.floor((b + 8) / 25);
            const g = Math.floor((b - f + 1) / 3);
            const h = (19 * a + b - d - g + 15) % 30;
            const i = Math.floor(c / 4);
            const k = c % 4;
            const l = (32 + 2 * e + 2 * i - h - k) % 7;
            const m = Math.floor((a + 11 * h + 22 * l) / 451);
            const month = Math.floor((h + l - 7 * m + 114) / 31);
            const day = ((h + l - 7 * m + 114) % 31) + 1;

            const easter = new Date(year, month - 1, day);
            holidays.push({ 
                date: easter.toISOString().split('T')[0], 
                name: 'Pasqua' 
            });

            // Luned√¨ dell'Angelo (Pasquetta)
            const easterMonday = new Date(easter);
            easterMonday.setDate(easter.getDate() + 1);
            holidays.push({ 
                date: easterMonday.toISOString().split('T')[0], 
                name: "Luned√¨ dell'Angelo" 
            });

            return holidays.sort((a, b) => a.date.localeCompare(b.date));
        }

        function calculateHolidays() {
            // Trova il range di anni necessario dai progetti
            let minYear = new Date().getFullYear();
            let maxYear = minYear;

            projects.forEach(project => {
                if (project.milestones) {
                    project.milestones.forEach(m => {
                        if (m.date) {
                            const year = new Date(m.date).getFullYear();
                            if (year < minYear) minYear = year;
                            if (year > maxYear) maxYear = year;
                        }
                    });
                }
                if (project.tasks) {
                    project.tasks.forEach(t => {
                        if (t.startDate) {
                            const year = new Date(t.startDate).getFullYear();
                            if (year < minYear) minYear = year;
                            if (year > maxYear) maxYear = year;
                        }
                        if (t.endDate) {
                            const year = new Date(t.endDate).getFullYear();
                            if (year < minYear) minYear = year;
                            if (year > maxYear) maxYear = year;
                        }
                    });
                }
            });

            // Genera festivit√† per tutti gli anni nel range
            holidays = [];
            for (let year = minYear; year <= maxYear; year++) {
                holidays = holidays.concat(getItalianHolidays(year));
                
                // Aggiungi festivit√† locali per questo anno
                localHolidays.forEach(lh => {
                    const month = lh.month.toString().padStart(2, '0');
                    const day = lh.day.toString().padStart(2, '0');
                    holidays.push({
                        date: `${year}-${month}-${day}`,
                        name: lh.name
                    });
                });
            }

            holidays.sort((a, b) => a.date.localeCompare(b.date));
            localStorage.setItem('projectPlanner_holidays', JSON.stringify(holidays));
        }

        function renderHolidays() {
            const tbody = document.querySelector('#holidaysTable tbody');
            tbody.innerHTML = '';

            holidays.forEach(holiday => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${holiday.date}</td>
                    <td>${holiday.name}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        // === GESTIONE PROGETTI ===
        function saveProject() {
            const client = document.getElementById('projectClient').value.trim();
            const code = document.getElementById('projectCode').value.trim();
            const description = document.getElementById('projectDescription').value.trim();
            
            if (!client || !code) {
                alert('Cliente e Codice sono obbligatori');
                return;
            }

            const project = {
                id: currentProjectId || Date.now(),
                client,
                code,
                description,
                milestones: currentProjectId ? projects.find(p => p.id === currentProjectId).milestones : [],
                tasks: currentProjectId ? projects.find(p => p.id === currentProjectId).tasks : []
            };

            if (currentProjectId) {
                const index = projects.findIndex(p => p.id === currentProjectId);
                projects[index] = project;
            } else {
                projects.push(project);
            }

            saveToIndexedDBAll();
            calculateHolidays();
            renderHolidays();
            renderProjects();
            updateProjectSelects();
            closeProjectModal();
        }

        function editProject(id) {
            const project = projects.find(p => p.id === id);
            if (!project) return;

            currentProjectId = id;
            document.getElementById('projectClient').value = project.client;
            document.getElementById('projectCode').value = project.code;
            document.getElementById('projectDescription').value = project.description;

            document.getElementById('projectClient').scrollIntoView({ behavior: 'smooth' });
        }

        function deleteProject(id) {
            if (!confirm('Sei sicuro di voler eliminare questo progetto?')) return;
            projects = projects.filter(p => p.id !== id);
            saveToIndexedDBAll();
            renderProjects();
            updateProjectSelects();
        }

        function clearProjectForm() {
            currentProjectId = null;
            document.getElementById('projectClient').value = '';
            document.getElementById('projectCode').value = '';
            document.getElementById('projectDescription').value = '';
        }

        function openProjectDetails(id) {
            currentProjectId = id;
            const project = projects.find(p => p.id === id);
            if (!project) return;

            document.getElementById('currentProjectName').textContent = `${project.client} - ${project.code}`;
            document.getElementById('projectDetails').style.display = 'block';
            document.querySelector('#projects > .action-bar').style.display = 'none';
            document.querySelector('#projects > h3').style.display = 'none';
            document.querySelector('#projectsTable').style.display = 'none';

            renderMilestones();
            renderTasks();
            updateResourceSelects();
        }

        function closeProjectDetails() {
            document.getElementById('projectDetails').style.display = 'none';
            document.querySelector('#projects > .action-bar').style.display = 'block';
            document.querySelector('#projects > h3').style.display = 'block';
            document.querySelector('#projectsTable').style.display = 'table';
            currentProjectId = null;
            renderProjects();
        }

        function renderProjects() {
            const tbody = document.querySelector('#projectsTable tbody');
            tbody.innerHTML = '';

            projects.forEach(project => {
                const stats = calculateProjectStats(project);
                const tr = document.createElement('tr');
                tr.className = 'project-item';
                
                tr.innerHTML = `
                    <td>${project.client}</td>
                    <td>${project.code}</td>
                    <td>${project.description}</td>
                    <td>${stats.startDate || '-'}</td>
                    <td>${stats.endDate || '-'}</td>
                    <td>${stats.completion}%</td>
                    <td class="action-buttons">
                        <button onclick="selectProject(${project.id})" class="secondary">‚úì Seleziona</button>
                        <button onclick="openProjectModal(${project.id})" class="secondary">‚úèÔ∏è Modifica</button>
                        <button onclick="openProjectDetails(${project.id})" class="secondary">üìã Dettagli</button>
                        <button onclick="deleteProject(${project.id})" class="delete">üóëÔ∏è Elimina</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function calculateProjectStats(project) {
            let startDate = null;
            let endDate = null;
            let totalCompletion = 0;
            let taskCount = 0;

            // Calculate from milestones
            if (project.milestones && project.milestones.length > 0) {
                project.milestones.forEach(m => {
                    if (!startDate || m.date < startDate) startDate = m.date;
                    if (!endDate || m.date > endDate) endDate = m.date;
                });
            }

            // Calculate from tasks
            if (project.tasks && project.tasks.length > 0) {
                project.tasks.forEach(task => {
                    if (task.startDate) {
                        if (!startDate || task.startDate < startDate) startDate = task.startDate;
                    }
                    if (task.endDate) {
                        if (!endDate || task.endDate > endDate) endDate = task.endDate;
                    }
                    totalCompletion += parseInt(task.completion || 0);
                    taskCount++;
                });
            }

            const completion = taskCount > 0 ? Math.round(totalCompletion / taskCount) : 0;

            return { startDate, endDate, completion };
        }

        // === GESTIONE MILESTONE ===
        function saveMilestone() {
            const name = document.getElementById('milestoneName').value.trim();
            const date = document.getElementById('milestoneDate').value;
            
            if (!name || !date) {
                alert('Nome e Data sono obbligatori');
                return;
            }

            const project = projects.find(p => p.id === currentProjectId);
            if (!project) return;

            if (!project.milestones) project.milestones = [];

            const milestone = {
                id: editingMilestoneId || Date.now(),
                name,
                date
            };

            if (editingMilestoneId) {
                const index = project.milestones.findIndex(m => m.id === editingMilestoneId);
                project.milestones[index] = milestone;
            } else {
                project.milestones.push(milestone);
            }

            saveToIndexedDBAll();
            calculateHolidays();
            renderHolidays();
            renderMilestones();
            closeMilestoneModal();
        }

        function editMilestone(id) {
            const project = projects.find(p => p.id === currentProjectId);
            if (!project) return;

            const milestone = project.milestones.find(m => m.id === id);
            if (!milestone) return;

            editingMilestoneId = id;
            document.getElementById('milestoneName').value = milestone.name;
            document.getElementById('milestoneDate').value = milestone.date;

            document.getElementById('milestoneName').scrollIntoView({ behavior: 'smooth' });
        }

        function deleteMilestone(id) {
            if (!confirm('Sei sicuro di voler eliminare questo punto di controllo?')) return;
            
            const project = projects.find(p => p.id === currentProjectId);
            if (!project) return;

            project.milestones = project.milestones.filter(m => m.id !== id);
            saveToIndexedDBAll();
            renderMilestones();
        }

        function clearMilestoneForm() {
            editingMilestoneId = null;
            document.getElementById('milestoneName').value = '';
            document.getElementById('milestoneDate').value = '';
        }

        function renderMilestones() {
            const project = projects.find(p => p.id === currentProjectId);
            if (!project) return;

            const tbody = document.querySelector('#milestonesTable tbody');
            tbody.innerHTML = '';

            if (!project.milestones) project.milestones = [];

            project.milestones.forEach(milestone => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${milestone.name}</td>
                    <td>${milestone.date}</td>
                    <td class="action-buttons">
                        <button onclick="openMilestoneModal(${milestone.id})" class="secondary">‚úèÔ∏è Modifica</button>
                        <button onclick="deleteMilestone(${milestone.id})" class="delete">üóëÔ∏è Elimina</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // === GESTIONE ATTIVIT√Ä ===
        function addTaskResourceRow() {
            const container = document.getElementById('taskResources');
            const resourceItems = container.querySelectorAll('.resource-item');
            
            // Rimuovi tutti i pulsanti "+ Aggiungi" esistenti
            resourceItems.forEach(item => {
                const addBtn = item.querySelector('button:not(.delete)');
                if (addBtn) {
                    const removeBtn = document.createElement('button');
                    removeBtn.type = 'button';
                    removeBtn.className = 'delete';
                    removeBtn.textContent = 'Rimuovi';
                    removeBtn.onclick = function() { removeTaskResource(this); };
                    addBtn.replaceWith(removeBtn);
                }
            });
            
            const newResource = document.createElement('div');
            newResource.className = 'resource-item';
            
            let options = '<option value="">-- Seleziona Risorsa --</option>';
            resources.forEach(r => {
                options += `<option value="${r.id}">${r.firstName} ${r.lastName}</option>`;
            });

            newResource.innerHTML = `
                <select class="task-resource-select">${options}</select>
                <label>Coinvolgimento:</label>
                <input type="number" class="task-resource-percentage" min="1" max="100" value="100" placeholder="%">
                <span>%</span>
                <button type="button" onclick="addTaskResource()">+ Aggiungi Risorsa</button>
            `;
            container.appendChild(newResource);
        }

        function addTaskResource() {
            addTaskResourceRow();
        }

        function removeTaskResource(button) {
            button.parentElement.remove();
        }

        function calculateEndDate() {
            const startDate = document.getElementById('taskStartDate').value;
            const duration = parseInt(document.getElementById('taskDuration').value);
            const saturdayWork = document.getElementById('taskSaturdayWork').checked;
            const sundayWork = document.getElementById('taskSundayWork').checked;

            if (!startDate || !duration) {
                document.getElementById('taskEndDate').value = '';
                return;
            }

            let currentDate = new Date(startDate + 'T00:00:00');
            let workDaysAdded = 0;

            while (workDaysAdded < duration) {
                const dayOfWeek = currentDate.getDay();
                const dateStr = currentDate.toISOString().split('T')[0];
                const isHoliday = holidays.some(h => h.date === dateStr);

                // Check if it's a working day
                const isSaturday = dayOfWeek === 6;
                const isSunday = dayOfWeek === 0;
                const isWorkingDay = !isHoliday && 
                                    (!isSaturday || saturdayWork) && 
                                    (!isSunday || sundayWork);

                if (isWorkingDay) {
                    workDaysAdded++;
                    if (workDaysAdded === duration) {
                        break;
                    }
                }
                
                currentDate.setDate(currentDate.getDate() + 1);
            }

            document.getElementById('taskEndDate').value = currentDate.toISOString().split('T')[0];
        }

        function calculateStartDate() {
            const endDate = document.getElementById('taskEndDate').value;
            const duration = parseInt(document.getElementById('taskDuration').value);
            const saturdayWork = document.getElementById('taskSaturdayWork').checked;
            const sundayWork = document.getElementById('taskSundayWork').checked;

            if (!endDate || !duration) {
                document.getElementById('taskStartDate').value = '';
                return;
            }

            let currentDate = new Date(endDate + 'T00:00:00');
            let workDaysAdded = 0;

            while (workDaysAdded < duration) {
                const dayOfWeek = currentDate.getDay();
                const dateStr = currentDate.toISOString().split('T')[0];
                const isHoliday = holidays.some(h => h.date === dateStr);

                // Check if it's a working day
                const isSaturday = dayOfWeek === 6;
                const isSunday = dayOfWeek === 0;
                const isWorkingDay = !isHoliday && 
                                    (!isSaturday || saturdayWork) && 
                                    (!isSunday || sundayWork);

                if (isWorkingDay) {
                    workDaysAdded++;
                    if (workDaysAdded === duration) {
                        break;
                    }
                }
                
                currentDate.setDate(currentDate.getDate() - 1);
            }

            document.getElementById('taskStartDate').value = currentDate.toISOString().split('T')[0];
        }

        function onCalcMethodChange() {
            const method = document.querySelector('input[name="calcMethod"]:checked').value;
            if (method === 'start') {
                calculateEndDate();
            } else {
                calculateStartDate();
            }
        }

        // Auto-calculate end date when inputs change
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('taskStartDate')?.addEventListener('change', function() {
                if (document.getElementById('calcFromStart')?.checked) calculateEndDate();
            });
            document.getElementById('taskEndDate')?.addEventListener('change', function() {
                if (document.getElementById('calcFromEnd')?.checked) calculateStartDate();
            });
            document.getElementById('taskDuration')?.addEventListener('input', onCalcMethodChange);
            document.getElementById('taskSaturdayWork')?.addEventListener('change', onCalcMethodChange);
            document.getElementById('taskSundayWork')?.addEventListener('change', onCalcMethodChange);
            document.getElementById('calcFromStart')?.addEventListener('change', onCalcMethodChange);
            document.getElementById('calcFromEnd')?.addEventListener('change', onCalcMethodChange);
        });

        function saveTask() {
            const name = document.getElementById('taskName').value.trim();
            const startDate = document.getElementById('taskStartDate').value;
            const duration = parseInt(document.getElementById('taskDuration').value);
            const completion = parseInt(document.getElementById('taskCompletion').value);
            const status = document.getElementById('taskStatus').value;
            const saturdayWork = document.getElementById('taskSaturdayWork').checked;
            const sundayWork = document.getElementById('taskSundayWork').checked;
            const endDate = document.getElementById('taskEndDate').value;
            
            if (!name || !duration) {
                alert('Nome e Durata sono obbligatori');
                return;
            }

            const assignedResources = [];
            document.querySelectorAll('.resource-item').forEach(item => {
                const resourceId = parseInt(item.querySelector('.task-resource-select').value);
                const percentage = parseInt(item.querySelector('.task-resource-percentage').value);
                if (resourceId && percentage) {
                    assignedResources.push({ resourceId, percentage });
                }
            });

            const project = projects.find(p => p.id === currentProjectId);
            if (!project) return;

            if (!project.tasks) project.tasks = [];

            const task = {
                id: editingTaskId || Date.now(),
                name,
                startDate,
                duration,
                completion,
                status,
                saturdayWork,
                sundayWork,
                endDate,
                resources: assignedResources
            };

            if (editingTaskId) {
                const index = project.tasks.findIndex(t => t.id === editingTaskId);
                project.tasks[index] = task;
            } else {
                project.tasks.push(task);
            }

            saveToIndexedDBAll();
            calculateHolidays();
            renderHolidays();
            renderTasks();
            closeTaskModal();
        }

        function editTask(id) {
            const project = projects.find(p => p.id === currentProjectId);
            if (!project) return;

            const task = project.tasks.find(t => t.id === id);
            if (!task) return;

            editingTaskId = id;
            document.getElementById('taskName').value = task.name;
            document.getElementById('taskStartDate').value = task.startDate || '';
            document.getElementById('taskDuration').value = task.duration;
            document.getElementById('taskCompletion').value = task.completion;
            document.getElementById('taskStatus').value = task.status;
            document.getElementById('taskSaturdayWork').checked = task.saturdayWork;
            document.getElementById('taskSundayWork').checked = task.sundayWork;
            document.getElementById('taskEndDate').value = task.endDate;

            // Clear and rebuild resource assignments
            const container = document.getElementById('taskResources');
            container.innerHTML = '';

            if (task.resources && task.resources.length > 0) {
                task.resources.forEach((res, index) => {
                    const newResource = document.createElement('div');
                    newResource.className = 'resource-item';
                    
                    let options = '<option value="">-- Seleziona Risorsa --</option>';
                    resources.forEach(r => {
                        const selected = r.id === res.resourceId ? 'selected' : '';
                        options += `<option value="${r.id}" ${selected}>${r.firstName} ${r.lastName}</option>`;
                    });

                    newResource.innerHTML = `
                        <select class="task-resource-select">${options}</select>
                        <label>Coinvolgimento:</label>
                        <input type="number" class="task-resource-percentage" min="1" max="100" value="${res.percentage}" placeholder="%">
                        <span>%</span>
                        ${index === 0 ? 
                            '<button type="button" onclick="addTaskResource()">+ Aggiungi Risorsa</button>' :
                            '<button type="button" onclick="removeTaskResource(this)" class="delete">Rimuovi</button>'}
                    `;
                    container.appendChild(newResource);
                });
            } else {
                addTaskResource();
            }

            document.getElementById('taskName').scrollIntoView({ behavior: 'smooth' });
        }

        function deleteTask(id) {
            if (!confirm('Sei sicuro di voler eliminare questa attivit√†?')) return;
            
            const project = projects.find(p => p.id === currentProjectId);
            if (!project) return;

            project.tasks = project.tasks.filter(t => t.id !== id);
            saveToIndexedDBAll();
            renderTasks();
        }

        function clearTaskForm() {
            editingTaskId = null;
            document.getElementById('taskName').value = '';
            document.getElementById('taskStartDate').value = '';
            document.getElementById('taskDuration').value = '1';
            document.getElementById('taskCompletion').value = '0';
            document.getElementById('taskStatus').value = 'in-corso';
            document.getElementById('taskSaturdayWork').checked = false;
            document.getElementById('taskSundayWork').checked = false;
            document.getElementById('taskEndDate').value = '';

            const container = document.getElementById('taskResources');
            container.innerHTML = '';
            addTaskResourceRow();
            updateResourceSelects();
        }

        function renderTasks() {
            const project = projects.find(p => p.id === currentProjectId);
            if (!project) return;

            const tbody = document.querySelector('#tasksTable tbody');
            tbody.innerHTML = '';

            if (!project.tasks) project.tasks = [];

            project.tasks.forEach(task => {
                const tr = document.createElement('tr');
                
                // Determine row class based on status and resource assignment
                let rowClass = '';
                const isCompleted = task.status === 'completata' || task.completion >= 100;
                const today = new Date().toISOString().split('T')[0];
                const isOverdue = !isCompleted && task.endDate && task.endDate < today;
                
                if (isOverdue) {
                    rowClass = 'status-overdue';
                } else if (isCompleted) {
                    rowClass = 'status-completed';
                } else if (task.status === 'annullata') {
                    rowClass = 'status-cancelled';
                } else if (task.status === 'pausa') {
                    rowClass = 'status-paused';
                } else if (task.status === 'in-corso') {
                    rowClass = 'status-in-progress';
                } else if (!task.resources || task.resources.length === 0) {
                    rowClass = 'status-not-assigned';
                }
                tr.className = rowClass;

                // Get resource names
                let resourcesStr = '-';
                if (task.resources && task.resources.length > 0) {
                    resourcesStr = task.resources.map(r => {
                        const resource = resources.find(res => res.id === r.resourceId);
                        if (resource) {
                            return `${resource.firstName} ${resource.lastName} (${r.percentage}%)`;
                        }
                        return '';
                    }).filter(s => s).join(', ');
                }

                const statusLabels = {
                    'in-corso': 'In Corso',
                    'pausa': 'In Pausa',
                    'completata': 'Completata',
                    'annullata': 'Annullata'
                };

                tr.innerHTML = `
                    <td>${task.name}</td>
                    <td>${resourcesStr}</td>
                    <td>${task.startDate || '-'}</td>
                    <td>${task.endDate || '-'}</td>
                    <td>${task.duration} giorni</td>
                    <td>${task.completion}%</td>
                    <td>${statusLabels[task.status]}</td>
                    <td class="action-buttons">
                        <button onclick="openTaskModal(${task.id})" class="secondary">‚úèÔ∏è Modifica</button>
                        <button onclick="deleteTask(${task.id})" class="delete">üóëÔ∏è Elimina</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // === GESTIONE TEMPLATE ===
        function saveTemplateStandalone() {
            const templateName = document.getElementById('templateName').value.trim();
            
            if (!templateName) {
                alert('Nome template obbligatorio');
                return;
            }

            const template = {
                id: currentTemplateId || Date.now(),
                name: templateName,
                milestones: currentTemplateId ? templates.find(t => t.id === currentTemplateId).milestones : [],
                tasks: currentTemplateId ? templates.find(t => t.id === currentTemplateId).tasks : []
            };

            if (currentTemplateId) {
                const index = templates.findIndex(t => t.id === currentTemplateId);
                templates[index] = template;
            } else {
                templates.push(template);
            }

            saveToIndexedDBAll();
            renderTemplates();
            updateTemplateSelects();
            updateApplyTemplateSelect();
            closeTemplateModal();
        }

        function editTemplate(id) {
            const template = templates.find(t => t.id === id);
            if (!template) return;

            currentTemplateId = id;
            document.getElementById('templateName').value = template.name;
            document.getElementById('templateName').scrollIntoView({ behavior: 'smooth' });
        }

        function openTemplateDetails(id) {
            currentTemplateId = id;
            const template = templates.find(t => t.id === id);
            if (!template) return;

            document.getElementById('currentTemplateName').textContent = template.name;
            document.getElementById('templateDetails').style.display = 'block';
            document.querySelector('#templates > .action-bar').style.display = 'none';
            document.querySelector('#templates > h3').style.display = 'none';
            document.querySelector('#templatesTable').style.display = 'none';

            renderTemplateMilestones();
            renderTemplateTasks();
        }

        function closeTemplateDetails() {
            document.getElementById('templateDetails').style.display = 'none';
            document.querySelector('#templates > .action-bar').style.display = 'block';
            document.querySelector('#templates > h3').style.display = 'block';
            document.querySelector('#templatesTable').style.display = 'table';
            currentTemplateId = null;
            clearTemplateForm();
        }

        function clearTemplateForm() {
            currentTemplateId = null;
            document.getElementById('templateName').value = '';
        }

        function deleteTemplate(id) {
            if (!confirm('Sei sicuro di voler eliminare questo template?')) return;
            templates = templates.filter(t => t.id !== id);
            saveToIndexedDBAll();
            renderTemplates();
            updateTemplateSelects();
        }

        function applyTemplateToProject(templateId, projectId) {
            const template = templates.find(t => t.id === templateId);
            const project = projects.find(p => p.id === projectId);

            if (!template || !project) return;

            if (!confirm('Questo sovrascriver√† i punti di controllo e le attivit√† del progetto. Continuare?')) {
                return;
            }

            // Trova la data di inizio del progetto (se esiste)
            let projectStartDate = null;
            if (project.milestones && project.milestones.length > 0) {
                projectStartDate = project.milestones[0].date;
            } else if (project.tasks && project.tasks.length > 0) {
                projectStartDate = project.tasks[0].startDate;
            }

            // Se non c'√® data di inizio, usa oggi
            if (!projectStartDate) {
                projectStartDate = new Date().toISOString().split('T')[0];
            }

            const baseDate = new Date(projectStartDate + 'T00:00:00');

            // Converti milestone template in milestone reali
            project.milestones = template.milestones.map(m => {
                const milestoneDate = new Date(baseDate);
                milestoneDate.setDate(baseDate.getDate() + (m.dayOffset || 0));
                return {
                    id: Date.now() + Math.random(),
                    name: m.name,
                    date: milestoneDate.toISOString().split('T')[0]
                };
            });

            // Converti task template in task reali
            project.tasks = template.tasks.map(t => {
                const taskStartDate = new Date(baseDate);
                taskStartDate.setDate(baseDate.getDate() + (t.startDayOffset || 0));
                
                // Calcola la data di fine
                const taskEndDate = calculateEndDateForTask(
                    taskStartDate.toISOString().split('T')[0],
                    t.duration,
                    t.saturdayWork,
                    t.sundayWork
                );

                return {
                    id: Date.now() + Math.random(),
                    name: t.name,
                    startDate: taskStartDate.toISOString().split('T')[0],
                    duration: t.duration,
                    completion: 0,
                    status: 'in-corso',
                    saturdayWork: t.saturdayWork,
                    sundayWork: t.sundayWork,
                    endDate: taskEndDate,
                    resources: []
                };
            });

            saveToIndexedDBAll();
            calculateHolidays();
            renderHolidays();
            renderProjects();
            alert('Template applicato con successo!');
        }

        function renderTemplates() {
            const tbody = document.querySelector('#templatesTable tbody');
            tbody.innerHTML = '';

            templates.forEach(template => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${template.name}</td>
                    <td>${template.milestones ? template.milestones.length : 0}</td>
                    <td>${template.tasks ? template.tasks.length : 0}</td>
                    <td class="action-buttons">
                        <button onclick="openTemplateModal(${template.id})" class="secondary">‚úèÔ∏è Modifica</button>
                        <button onclick="openTemplateDetails(${template.id})" class="secondary">üìã Dettagli</button>
                        <button onclick="deleteTemplate(${template.id})" class="delete">üóëÔ∏è Elimina</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // === HELPER FUNCTIONS ===
        function updateResourceSelects() {
            const selects = document.querySelectorAll('.task-resource-select');
            selects.forEach(select => {
                const currentValue = select.value;
                select.innerHTML = '<option value="">-- Seleziona Risorsa --</option>';
                resources.forEach(r => {
                    const option = document.createElement('option');
                    option.value = r.id;
                    option.textContent = `${r.firstName} ${r.lastName}`;
                    if (r.id == currentValue) option.selected = true;
                    select.appendChild(option);
                });
            });
        }

        function updateProjectSelects() {
            const select = document.getElementById('projectSelectForTemplate');
            if (select) {
                select.innerHTML = '<option value="">-- Seleziona Progetto --</option>';
                projects.forEach(p => {
                    const option = document.createElement('option');
                    option.value = p.id;
                    option.textContent = `${p.client} - ${p.code}`;
                    select.appendChild(option);
                });
            }
        }

        function updateTemplateSelects() {
            const select = document.getElementById('templateSelect');
            if (select) {
                select.innerHTML = '<option value="">-- Seleziona Template --</option>';
                templates.forEach(t => {
                    const option = document.createElement('option');
                    option.value = t.id;
                    option.textContent = t.name;
                    select.appendChild(option);
                });
            }
        }

        // === GESTIONE TEMPLATE MILESTONE E TASK ===
        function saveTemplateMilestone() {
            const name = document.getElementById('templateMilestoneName').value.trim();
            const dayOffset = parseInt(document.getElementById('templateMilestoneDay').value);
            
            if (!name || isNaN(dayOffset)) {
                alert('Nome e Giorni sono obbligatori');
                return;
            }

            const template = templates.find(t => t.id === currentTemplateId);
            if (!template) return;

            if (!template.milestones) template.milestones = [];

            const milestone = {
                id: editingTemplateMilestoneId || Date.now(),
                name,
                dayOffset
            };

            if (editingTemplateMilestoneId) {
                const index = template.milestones.findIndex(m => m.id === editingTemplateMilestoneId);
                template.milestones[index] = milestone;
            } else {
                template.milestones.push(milestone);
            }

            saveToIndexedDBAll();
            renderTemplateMilestones();
            closeTemplateMilestoneModal();
        }

        function editTemplateMilestone(id) {
            const template = templates.find(t => t.id === currentTemplateId);
            if (!template) return;

            const milestone = template.milestones.find(m => m.id === id);
            if (!milestone) return;

            editingTemplateMilestoneId = id;
            document.getElementById('templateMilestoneName').value = milestone.name;
            document.getElementById('templateMilestoneDay').value = milestone.dayOffset;

            document.getElementById('templateMilestoneName').scrollIntoView({ behavior: 'smooth' });
        }

        function deleteTemplateMilestone(id) {
            if (!confirm('Sei sicuro di voler eliminare questo punto di controllo?')) return;
            
            const template = templates.find(t => t.id === currentTemplateId);
            if (!template) return;

            template.milestones = template.milestones.filter(m => m.id !== id);
            saveToIndexedDBAll();
            renderTemplateMilestones();
        }

        function clearTemplateMilestoneForm() {
            editingTemplateMilestoneId = null;
            document.getElementById('templateMilestoneName').value = '';
            document.getElementById('templateMilestoneDay').value = '0';
        }

        function renderTemplateMilestones() {
            const template = templates.find(t => t.id === currentTemplateId);
            if (!template) return;

            const tbody = document.querySelector('#templateMilestonesTable tbody');
            tbody.innerHTML = '';

            if (!template.milestones) template.milestones = [];

            template.milestones.forEach(milestone => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${milestone.name}</td>
                    <td>${milestone.dayOffset}</td>
                    <td class="action-buttons">
                        <button onclick="openTemplateMilestoneModal(${milestone.id})" class="secondary">‚úèÔ∏è Modifica</button>
                        <button onclick="deleteTemplateMilestone(${milestone.id})" class="delete">üóëÔ∏è Elimina</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function saveTemplateTask() {
            const name = document.getElementById('templateTaskName').value.trim();
            const startDayOffset = parseInt(document.getElementById('templateTaskStartDay').value);
            const duration = parseInt(document.getElementById('templateTaskDuration').value);
            const saturdayWork = document.getElementById('templateTaskSaturdayWork').checked;
            const sundayWork = document.getElementById('templateTaskSundayWork').checked;
            
            if (!name || isNaN(startDayOffset) || !duration) {
                alert('Nome, Giorni dall\'inizio e Durata sono obbligatori');
                return;
            }

            const template = templates.find(t => t.id === currentTemplateId);
            if (!template) return;

            if (!template.tasks) template.tasks = [];

            const task = {
                id: editingTemplateTaskId || Date.now(),
                name,
                startDayOffset,
                duration,
                saturdayWork,
                sundayWork
            };

            if (editingTemplateTaskId) {
                const index = template.tasks.findIndex(t => t.id === editingTemplateTaskId);
                template.tasks[index] = task;
            } else {
                template.tasks.push(task);
            }

            saveToIndexedDBAll();
            renderTemplateTasks();
            closeTemplateTaskModal();
        }

        function editTemplateTask(id) {
            const template = templates.find(t => t.id === currentTemplateId);
            if (!template) return;

            const task = template.tasks.find(t => t.id === id);
            if (!task) return;

            editingTemplateTaskId = id;
            document.getElementById('templateTaskName').value = task.name;
            document.getElementById('templateTaskStartDay').value = task.startDayOffset;
            document.getElementById('templateTaskDuration').value = task.duration;
            document.getElementById('templateTaskSaturdayWork').checked = task.saturdayWork;
            document.getElementById('templateTaskSundayWork').checked = task.sundayWork;

            document.getElementById('templateTaskName').scrollIntoView({ behavior: 'smooth' });
        }

        function deleteTemplateTask(id) {
            if (!confirm('Sei sicuro di voler eliminare questa attivit√†?')) return;
            
            const template = templates.find(t => t.id === currentTemplateId);
            if (!template) return;

            template.tasks = template.tasks.filter(t => t.id !== id);
            saveToIndexedDBAll();
            renderTemplateTasks();
        }

        function clearTemplateTaskForm() {
            editingTemplateTaskId = null;
            document.getElementById('templateTaskName').value = '';
            document.getElementById('templateTaskStartDay').value = '0';
            document.getElementById('templateTaskDuration').value = '1';
            document.getElementById('templateTaskSaturdayWork').checked = false;
            document.getElementById('templateTaskSundayWork').checked = false;
        }

        function renderTemplateTasks() {
            const template = templates.find(t => t.id === currentTemplateId);
            if (!template) return;

            const tbody = document.querySelector('#templateTasksTable tbody');
            tbody.innerHTML = '';

            if (!template.tasks) template.tasks = [];

            template.tasks.forEach(task => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${task.name}</td>
                    <td>${task.startDayOffset}</td>
                    <td>${task.duration} giorni</td>
                    <td>${task.saturdayWork ? '‚úì' : '-'}</td>
                    <td>${task.sundayWork ? '‚úì' : '-'}</td>
                    <td class="action-buttons">
                        <button onclick="openTemplateTaskModal(${task.id})" class="secondary">‚úèÔ∏è Modifica</button>
                        <button onclick="deleteTemplateTask(${task.id})" class="delete">üóëÔ∏è Elimina</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function showApplyTemplateDialog(projectId) {
            if (templates.length === 0) {
                alert('Nessun template disponibile. Crea prima un template.');
                return;
            }

            const templateOptions = templates.map(t => `${t.id}. ${t.name}`).join('\n');
            const templateId = prompt('Seleziona template da applicare:\n\n' + templateOptions + '\n\nInserisci il numero del template:');
            
            if (templateId) {
                const id = parseInt(templateId);
                if (templates.find(t => t.id === id)) {
                    applyTemplateToProject(id, projectId);
                } else {
                    alert('Template non valido');
                }
            }
        }

        function calculateEndDateForTask(startDate, duration, saturdayWork, sundayWork) {
            let currentDate = new Date(startDate + 'T00:00:00');
            let workDaysLeft = duration;

            while (workDaysLeft > 0) {
                const dayOfWeek = currentDate.getDay();
                const dateStr = currentDate.toISOString().split('T')[0];
                const isHoliday = holidays.some(h => h.date === dateStr);

                const isSaturday = dayOfWeek === 6;
                const isSunday = dayOfWeek === 0;
                const isWorkingDay = !isHoliday && 
                                    (!isSaturday || saturdayWork) && 
                                    (!isSunday || sundayWork);

                if (isWorkingDay) {
                    workDaysLeft--;
                }

                if (workDaysLeft > 0) {
                    currentDate.setDate(currentDate.getDate() + 1);
                }
            }

            return currentDate.toISOString().split('T')[0];
        }

        // === IMPORT/EXPORT ===
        function exportData() {
            const data = {
                version: '1.0',
                exportDate: new Date().toISOString(),
                resources,
                localHolidays,
                projects,
                templates
            };

            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `project-planner-export-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            URL.revokeObjectURL(url);
        }

        function importData() {
            const fileInput = document.getElementById('importFile');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Seleziona un file da importare');
                return;
            }

            if (!confirm('Questo sostituir√† TUTTI i dati correnti. Sei sicuro?')) {
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    resources = data.resources || [];
                    localHolidays = data.localHolidays || [];
                    projects = data.projects || [];
                    templates = data.templates || [];
                    
                    saveToIndexedDBAll();
                    calculateHolidays();
                    renderResources();
                    renderLocalHolidays();
                    renderHolidays();
                    renderProjects();
                    renderTemplates();
                    updateResourceSelects();
                    updateProjectSelects();
                    updateTemplateSelects();
                    
                    alert('Dati importati con successo!');
                    fileInput.value = '';
                } catch (error) {
                    alert('Errore nell\'importazione: ' + error.message);
                }
            };
            reader.readAsText(file);
        }

        function importDataMerge() {
            const fileInput = document.getElementById('importFile');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Seleziona un file da importare');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    // Merge data with new IDs
                    if (data.resources) {
                        data.resources.forEach(r => {
                            r.id = Date.now() + Math.random();
                            resources.push(r);
                        });
                    }
                    
                    if (data.localHolidays) {
                        data.localHolidays.forEach(h => {
                            h.id = Date.now() + Math.random();
                            localHolidays.push(h);
                        });
                    }
                    
                    if (data.projects) {
                        data.projects.forEach(p => {
                            p.id = Date.now() + Math.random();
                            projects.push(p);
                        });
                    }
                    
                    if (data.templates) {
                        data.templates.forEach(t => {
                            t.id = Date.now() + Math.random();
                            templates.push(t);
                        });
                    }
                    
                    saveToIndexedDBAll();
                    calculateHolidays();
                    renderResources();
                    renderLocalHolidays();
                    renderHolidays();
                    renderProjects();
                    renderTemplates();
                    updateResourceSelects();
                    updateProjectSelects();
                    updateTemplateSelects();
                    
                    alert('Dati uniti con successo!');
                    fileInput.value = '';
                } catch (error) {
                    alert('Errore nell\'importazione: ' + error.message);
                }
            };
            reader.readAsText(file);
        }

        // === STORAGE ===
        async function saveToIndexedDBAll() {
            try {
                await saveToIndexedDB('resources', resources);
                await saveToIndexedDB('localHolidays', localHolidays);
                await saveToIndexedDB('projects', projects);
                await saveToIndexedDB('templates', templates);
            } catch (error) {
                console.error('Errore salvataggio IndexedDB:', error);
            }
        }

        async function loadFromIndexedDBAll() {
            try {
                resources = await loadFromIndexedDB('resources');
                localHolidays = await loadFromIndexedDB('localHolidays');
                projects = await loadFromIndexedDB('projects');
                templates = await loadFromIndexedDB('templates');
                
                // Carica holidays (calcolato, non salvato)
                const savedHolidays = localStorage.getItem('projectPlanner_holidays');
                if (savedHolidays) holidays = JSON.parse(savedHolidays);
            } catch (error) {
                console.error('Errore caricamento IndexedDB:', error);
            }
        }

        // === GANTT CHART ===
        function renderGantt() {
            const projectFilter = document.getElementById('ganttProjectFilter')?.value;
            const periodFilter = document.getElementById('ganttPeriodFilter')?.value || 'month';
            const viewFilter = document.getElementById('ganttViewFilter')?.value || 'projects';
            const container = document.getElementById('ganttChart');
            
            if (!container) return;
            
            container.innerHTML = '';

            // Trova il range di date
            let minDate = null;
            let maxDate = null;
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const filteredProjects = projectFilter ? 
                projects.filter(p => p.id == projectFilter) : 
                projects;

            filteredProjects.forEach(project => {
                if (project.milestones) {
                    project.milestones.forEach(m => {
                        if (m.date) {
                            const date = new Date(m.date);
                            if (!minDate || date < minDate) minDate = date;
                            if (!maxDate || date > maxDate) maxDate = date;
                        }
                    });
                }
                if (project.tasks) {
                    project.tasks.forEach(t => {
                        if (t.startDate) {
                            const date = new Date(t.startDate);
                            if (!minDate || date < minDate) minDate = date;
                        }
                        if (t.endDate) {
                            const date = new Date(t.endDate);
                            if (!maxDate || date > maxDate) maxDate = date;
                        }
                    });
                }
            });

            if (!minDate || !maxDate) {
                container.innerHTML = '<p style="padding: 20px; text-align: center;">Nessun dato da visualizzare. Aggiungi progetti con milestone o attivit√†.</p>';
                return;
            }

            // Applica filtro periodo
            switch (periodFilter) {
                case 'week':
                    minDate = new Date(today);
                    // Vai al luned√¨ della settimana corrente
                    const dayOfWeek = minDate.getDay();
                    const diff = dayOfWeek === 0 ? -6 : 1 - dayOfWeek; // domenica = 0, luned√¨ = 1
                    minDate.setDate(minDate.getDate() + diff);
                    maxDate = new Date(minDate);
                    maxDate.setDate(maxDate.getDate() + 6); // 7 giorni dalla domenica inclusa
                    break;
                case 'month':
                    minDate = new Date(today.getFullYear(), today.getMonth(), 1);
                    maxDate = new Date(today.getFullYear(), today.getMonth() + 1, 0); // ultimo giorno del mese
                    break;
                case 'quarter':
                    minDate = new Date(today.getFullYear(), today.getMonth(), 1);
                    maxDate = new Date(today.getFullYear(), today.getMonth() + 3, 0); // 3 mesi dal primo del mese corrente
                    break;
                case 'year':
                    minDate = new Date(today.getFullYear(), 0, 1);
                    maxDate = new Date(today.getFullYear(), 11, 31); // 31 dicembre
                    break;
            }

            // Genera timeline
            const days = [];
            const currentDate = new Date(minDate);
            while (currentDate <= maxDate) {
                days.push(new Date(currentDate));
                currentDate.setDate(currentDate.getDate() + 1);
            }

            // Crea header timeline
            const timeline = document.createElement('div');
            timeline.className = 'gantt-timeline';
            
            // Aggiungi cella vuota per allineare con le label
            const labelCell = document.createElement('div');
            labelCell.className = 'gantt-timeline-label';
            labelCell.textContent = 'Progetto / Attivit√†';
            timeline.appendChild(labelCell);
            
            days.forEach(day => {
                const item = document.createElement('div');
                item.className = 'gantt-timeline-item';
                item.textContent = `${day.getDate()}/${day.getMonth() + 1}`;
                timeline.appendChild(item);
            });
            container.appendChild(timeline);

            if (viewFilter === 'projects') {
                renderGanttByProjects(container, filteredProjects, days, minDate, maxDate);
            } else {
                renderGanttByResources(container, filteredProjects, days, minDate, maxDate);
            }
        }

        function renderGanttByProjects(container, filteredProjects, days, minDate, maxDate) {
            filteredProjects.forEach(project => {
                // Row per progetto
                const projectRow = createGanttRow(`üìÅ ${project.client} - ${project.code}`, days, 'project', project.id);
                container.appendChild(projectRow);

                // Calcola barra progetto (dall'inizio alla fine)
                const stats = calculateProjectStats(project);
                if (stats.startDate && stats.endDate) {
                    addGanttBar(projectRow, stats.startDate, stats.endDate, project.client, days, minDate, 'project');
                }

                // Milestone
                if (project.milestones && project.milestones.length > 0) {
                    project.milestones.forEach(milestone => {
                        const milestoneRow = createGanttRow(`  ‚óÜ ${milestone.name}`, days, 'milestone', project.id);
                        container.appendChild(milestoneRow);
                        addGanttBar(milestoneRow, milestone.date, milestone.date, milestone.name, days, minDate, 'milestone');
                    });
                }

                // Tasks
                if (project.tasks && project.tasks.length > 0) {
                    project.tasks.forEach(task => {
                        if (task.startDate && task.endDate) {
                            const taskRow = createGanttRow(`  ‚ñ™ ${task.name}`, days, 'task', project.id);
                            container.appendChild(taskRow);
                            
                            let barClass = 'task';
                            if (task.status === 'pausa') barClass += ' status-paused';
                            if (task.status === 'annullata') barClass += ' status-cancelled';
                            if (!task.resources || task.resources.length === 0) barClass += ' not-assigned';
                            
                            addGanttBar(taskRow, task.startDate, task.endDate, task.name, days, minDate, barClass, () => {
                                currentProjectId = project.id;
                                openTaskModal(task.id);
                            });
                        }
                    });
                }
            });
        }

        function renderGanttByResources(container, filteredProjects, days, minDate, maxDate) {
            const resourceTasks = {};

            // Raggruppa task per risorsa
            filteredProjects.forEach(project => {
                if (project.tasks) {
                    project.tasks.forEach(task => {
                        if (task.resources && task.startDate && task.endDate) {
                            task.resources.forEach(res => {
                                const resource = resources.find(r => r.id === res.resourceId);
                                if (resource) {
                                    const key = resource.id;
                                    if (!resourceTasks[key]) {
                                        resourceTasks[key] = {
                                            resource,
                                            tasks: []
                                        };
                                    }
                                    resourceTasks[key].tasks.push({
                                        ...task,
                                        project,
                                        percentage: res.percentage
                                    });
                                }
                            });
                        }
                    });
                }
            });

            // Renderizza per risorsa
            Object.values(resourceTasks).forEach(({ resource, tasks }) => {
                const resourceRow = createGanttRow(`üë§ ${resource.firstName} ${resource.lastName}`, days);
                container.appendChild(resourceRow);

                tasks.forEach(task => {
                    const taskRow = createGanttRow(`  ${task.project.code}: ${task.name} (${task.percentage}%)`, days);
                    container.appendChild(taskRow);
                    
                    let barClass = 'task';
                    if (task.status === 'pausa') barClass += ' status-paused';
                    if (task.status === 'annullata') barClass += ' status-cancelled';
                    
                    addGanttBar(taskRow, task.startDate, task.endDate, task.name, days, minDate, barClass, () => {
                        currentProjectId = task.project.id;
                        openTaskModal(task.id);
                    });
                });
            });
        }

        function createGanttRow(label, days, rowType, projectId) {
            const row = document.createElement('div');
            row.className = 'gantt-row';
            if (rowType) row.dataset.rowType = rowType;
            if (projectId !== undefined) row.dataset.projectId = projectId;

            const labelDiv = document.createElement('div');
            labelDiv.className = 'gantt-row-label';
            
            // Aggiungi icona expand/collapse per progetti
            if (rowType === 'project') {
                const expandIcon = document.createElement('span');
                expandIcon.className = 'gantt-expand-icon';
                expandIcon.textContent = '‚ñº'; // freccia gi√π
                expandIcon.onclick = function(e) {
                    e.stopPropagation();
                    toggleGanttProject(projectId);
                };
                labelDiv.appendChild(expandIcon);
            }
            
            const labelText = document.createElement('span');
            labelText.textContent = label;
            labelDiv.appendChild(labelText);
            
            row.appendChild(labelDiv);

            const barsDiv = document.createElement('div');
            barsDiv.className = 'gantt-row-bars';

            const today = new Date();
            today.setHours(0, 0, 0, 0);

            days.forEach(day => {
                const dayDiv = document.createElement('div');
                dayDiv.className = 'gantt-day';
                
                const dayOfWeek = day.getDay();
                if (dayOfWeek === 0 || dayOfWeek === 6) {
                    dayDiv.classList.add('weekend');
                }

                const dateStr = day.toISOString().split('T')[0];
                if (holidays.some(h => h.date === dateStr)) {
                    dayDiv.classList.add('holiday');
                }

                if (dateStr === today.toISOString().split('T')[0]) {
                    dayDiv.classList.add('today');
                }

                barsDiv.appendChild(dayDiv);
            });

            row.appendChild(barsDiv);
            return row;
        }

        function toggleGanttProject(projectId) {
            const projectRows = document.querySelectorAll(`.gantt-row[data-project-id="${projectId}"]`);
            const projectRow = document.querySelector(`.gantt-row[data-row-type="project"][data-project-id="${projectId}"]`);
            
            if (!projectRow) return;
            
            const icon = projectRow.querySelector('.gantt-expand-icon');
            const isCollapsed = icon.textContent === '‚ñ∂'; // freccia destra
            
            projectRows.forEach(row => {
                if (row.dataset.rowType !== 'project') {
                    if (isCollapsed) {
                        row.classList.remove('hidden');
                    } else {
                        row.classList.add('hidden');
                    }
                }
            });
            
            icon.textContent = isCollapsed ? '‚ñº' : '‚ñ∂';
        }

        function addGanttBar(row, startDate, endDate, label, days, minDate, className, onClickCallback) {
            const start = new Date(startDate);
            const end = new Date(endDate);
            const firstDay = days[0];
            const lastDay = days[days.length - 1];
            
            // Se l'attivit√† √® completamente fuori dal range visibile, non disegnarla
            if (end < firstDay || start > lastDay) return;
            
            // Clampa le date ai limiti visibili
            let startIndex = days.findIndex(d => d.toISOString().split('T')[0] === startDate);
            let endIndex = days.findIndex(d => d.toISOString().split('T')[0] === endDate);
            
            // Se start √® prima del primo giorno visibile, inizia dal primo giorno
            if (startIndex === -1 && start < firstDay) {
                startIndex = 0;
            }
            
            // Se end √® dopo l'ultimo giorno visibile, finisce all'ultimo giorno
            if (endIndex === -1 && end > lastDay) {
                endIndex = days.length - 1;
            }
            
            // Se ancora non trovati, esci
            if (startIndex === -1 || endIndex === -1) return;

            const bar = document.createElement('div');
            bar.className = `gantt-bar ${className}`;
            bar.textContent = label;
            bar.title = `${label}\n${startDate} - ${endDate}`;
            
            // Aggiungi click handler se fornito
            if (onClickCallback) {
                bar.style.cursor = 'pointer';
                bar.onclick = onClickCallback;
            }
            
            const dayWidth = 100 / days.length;
            bar.style.left = `${startIndex * dayWidth}%`;
            
            if (className === 'milestone') {
                bar.style.left = `calc(${startIndex * dayWidth}% + 10px)`;
            } else {
                bar.style.width = `${(endIndex - startIndex + 1) * dayWidth}%`;
            }

            row.querySelector('.gantt-row-bars').appendChild(bar);
        }

        function updateGanttFilters() {
            const projectSelect = document.getElementById('ganttProjectFilter');
            if (projectSelect) {
                const currentValue = projectSelect.value;
                projectSelect.innerHTML = '<option value="">Tutti i Progetti</option>';
                projects.forEach(p => {
                    const option = document.createElement('option');
                    option.value = p.id;
                    option.textContent = `${p.client} - ${p.code}`;
                    if (p.id == currentValue) option.selected = true;
                    projectSelect.appendChild(option);
                });
            }
        }

        // === VISTA RISORSE ===
        function renderResourceView() {
            const resourceFilter = document.getElementById('resourceViewFilter')?.value;
            const startDateInput = document.getElementById('resourceViewStartDate')?.value;
            const endDateInput = document.getElementById('resourceViewEndDate')?.value;
            const container = document.getElementById('resourceViewContainer');
            
            if (!container) return;
            
            container.innerHTML = '';

            // Default: prossimi 30 giorni
            const startDate = startDateInput ? new Date(startDateInput) : new Date();
            const endDate = endDateInput ? new Date(endDateInput) : new Date(startDate.getTime() + 30 * 24 * 60 * 60 * 1000);

            const filteredResources = resourceFilter ? 
                resources.filter(r => r.id == resourceFilter) : 
                resources;

            if (filteredResources.length === 0) {
                container.innerHTML = '<p style="padding: 20px; text-align: center;">Nessuna risorsa disponibile.</p>';
                return;
            }

            filteredResources.forEach(resource => {
                const card = createResourceCard(resource, startDate, endDate);
                container.appendChild(card);
            });
        }

        function createResourceCard(resource, startDate, endDate) {
            const card = document.createElement('div');
            card.className = 'resource-card';

            // Raccogli tutte le assegnazioni per questa risorsa
            const assignments = [];
            projects.forEach(project => {
                if (project.tasks) {
                    project.tasks.forEach(task => {
                        if (task.resources && task.startDate && task.endDate) {
                            const res = task.resources.find(r => r.resourceId === resource.id);
                            if (res) {
                                const taskStart = new Date(task.startDate);
                                const taskEnd = new Date(task.endDate);
                                
                                // Filtra per periodo
                                if (taskEnd >= startDate && taskStart <= endDate) {
                                    assignments.push({
                                        project,
                                        task,
                                        percentage: res.percentage,
                                        startDate: task.startDate,
                                        endDate: task.endDate
                                    });
                                }
                            }
                        }
                    });
                }
            });

            // Calcola sovraccarico
            const overload = calculateResourceOverload(assignments);
            if (overload.maxLoad > 100) {
                card.classList.add('overloaded');
            }

            // Header
            const header = document.createElement('div');
            header.className = 'resource-header';
            
            const name = document.createElement('div');
            name.className = 'resource-name';
            name.textContent = `${resource.firstName} ${resource.lastName}`;
            header.appendChild(name);

            const load = document.createElement('div');
            load.className = 'resource-load';
            if (overload.maxLoad <= 100) {
                load.classList.add('normal');
                load.textContent = `Carico: ${overload.maxLoad.toFixed(0)}%`;
            } else if (overload.maxLoad <= 150) {
                load.classList.add('warning');
                load.textContent = `‚ö†Ô∏è Sovraccarico: ${overload.maxLoad.toFixed(0)}%`;
            } else {
                load.classList.add('overload');
                load.textContent = `üõë Critico: ${overload.maxLoad.toFixed(0)}%`;
            }
            header.appendChild(load);

            card.appendChild(header);

            // Assenze
            if (resource.absences && resource.absences.length > 0) {
                const absencesDiv = document.createElement('div');
                absencesDiv.style.marginBottom = '10px';
                absencesDiv.style.fontSize = '13px';
                absencesDiv.style.color = 'var(--text-tertiary)';
                absencesDiv.innerHTML = '<strong>Assenze:</strong> ' + 
                    resource.absences.map(a => {
                        if (a.start === a.end) return a.start;
                        return `${a.start} - ${a.end}`;
                    }).join(', ');
                card.appendChild(absencesDiv);
            }

            // Timeline assegnazioni
            if (assignments.length > 0) {
                const timeline = document.createElement('div');
                timeline.className = 'resource-timeline';

                // Ordina per data
                assignments.sort((a, b) => a.startDate.localeCompare(b.startDate));

                assignments.forEach(assignment => {
                    const assignDiv = document.createElement('div');
                    assignDiv.className = 'resource-assignment';

                    // Verifica conflitti (sovrapposizioni)
                    const hasConflict = checkDateOverlap(assignment, assignments);
                    if (hasConflict) {
                        assignDiv.classList.add('conflict');
                    }

                    const assignHeader = document.createElement('div');
                    assignHeader.className = 'assignment-header';
                    assignHeader.innerHTML = `
                        <span>${assignment.project.client} - ${assignment.task.name}</span>
                        <span>${assignment.percentage}%</span>
                    `;
                    assignDiv.appendChild(assignHeader);

                    const assignDetails = document.createElement('div');
                    assignDetails.className = 'assignment-details';
                    assignDetails.innerHTML = `
                        ${assignment.startDate} ‚Üí ${assignment.endDate} | 
                        Stato: ${assignment.task.status} | 
                        Completamento: ${assignment.task.completion}%
                        ${hasConflict ? ' | <strong style="color: var(--danger-color);">‚ö†Ô∏è SOVRAPPOSIZIONE</strong>' : ''}
                    `;
                    assignDiv.appendChild(assignDetails);

                    timeline.appendChild(assignDiv);
                });

                card.appendChild(timeline);
            } else {
                const noAssign = document.createElement('div');
                noAssign.style.padding = '10px';
                noAssign.style.fontStyle = 'italic';
                noAssign.style.color = 'var(--text-tertiary)';
                noAssign.textContent = 'Nessuna assegnazione nel periodo selezionato';
                card.appendChild(noAssign);
            }

            return card;
        }

        function selectProject(id) {
            document.getElementById('selectedProjectId').value = id;
            // Evidenzia riga selezionata
            document.querySelectorAll('#projectsTable tbody tr').forEach(tr => {
                tr.style.backgroundColor = '';
            });
            event.target.closest('tr').style.backgroundColor = 'var(--bg-hover)';
        }

        function applyTemplateFromSelect() {
            const templateId = parseInt(document.getElementById('applyTemplateSelect').value);
            const projectId = parseInt(document.getElementById('selectedProjectId').value);

            if (!templateId) {
                alert('Seleziona un template da applicare');
                return;
            }

            if (!projectId) {
                alert('Seleziona un progetto cliccando su "Seleziona"');
                return;
            }

            applyTemplateToProject(templateId, projectId);
            document.getElementById('applyTemplateSelect').value = '';
            document.getElementById('selectedProjectId').value = '';
            
            // Rimuovi evidenziazione
            document.querySelectorAll('#projectsTable tbody tr').forEach(tr => {
                tr.style.backgroundColor = '';
            });
        }

        function updateApplyTemplateSelect() {
            const select = document.getElementById('applyTemplateSelect');
            if (select) {
                select.innerHTML = '<option value="">-- Seleziona Template --</option>';
                templates.forEach(t => {
                    const option = document.createElement('option');
                    option.value = t.id;
                    option.textContent = t.name;
                    select.appendChild(option);
                });
            }
        }

        function calculateResourceOverload(assignments) {
            // Calcola il carico massimo giornaliero
            const dailyLoad = {};

            assignments.forEach(assignment => {
                const start = new Date(assignment.startDate);
                const end = new Date(assignment.endDate);
                
                const currentDate = new Date(start);
                while (currentDate <= end) {
                    const dateStr = currentDate.toISOString().split('T')[0];
                    if (!dailyLoad[dateStr]) dailyLoad[dateStr] = 0;
                    dailyLoad[dateStr] += assignment.percentage;
                    currentDate.setDate(currentDate.getDate() + 1);
                }
            });

            const maxLoad = Math.max(...Object.values(dailyLoad), 0);
            return { maxLoad, dailyLoad };
        }

        function checkDateOverlap(assignment, allAssignments) {
            const start1 = new Date(assignment.startDate);
            const end1 = new Date(assignment.endDate);

            return allAssignments.some(other => {
                if (other === assignment) return false;
                
                const start2 = new Date(other.startDate);
                const end2 = new Date(other.endDate);

                return start1 <= end2 && end1 >= start2;
            });
        }

        function updateResourceViewFilters() {
            const resourceSelect = document.getElementById('resourceViewFilter');
            if (resourceSelect) {
                const currentValue = resourceSelect.value;
                resourceSelect.innerHTML = '<option value="">Tutte le Risorse</option>';
                resources.forEach(r => {
                    const option = document.createElement('option');
                    option.value = r.id;
                    option.textContent = `${r.firstName} ${r.lastName}`;
                    if (r.id == currentValue) option.selected = true;
                    resourceSelect.appendChild(option);
                });
            }

            // Imposta date default
            const startDateInput = document.getElementById('resourceViewStartDate');
            const endDateInput = document.getElementById('resourceViewEndDate');
            if (startDateInput && !startDateInput.value) {
                startDateInput.value = new Date().toISOString().split('T')[0];
            }
            if (endDateInput && !endDateInput.value) {
                const endDate = new Date();
                endDate.setDate(endDate.getDate() + 30);
                endDateInput.value = endDate.toISOString().split('T')[0];
            }
        }
    </script>
</body>
</html>
